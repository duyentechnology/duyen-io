<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duyên — Your Life's Tapestry</title>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,300;0,400;0,600;0,700;1,400&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --warm-cream: #FDF8F5;
            --soft-sand: #FAF0EA;
            --blush: #F5E6DD;
            --golden-thread: #B08968;
            --warm-brown: #7D6E64;
            --deep-earth: #3D2E24;
            --brand-red: #C85A3E;
            --brand-red-hover: #b04a2e;
            --sage: #81B29A;
            --text-primary: #3D2E24;
            --text-secondary: #5D4E44;
            --text-muted: #9A8478;
            --border-light: #E8DDD6;
            --card-shadow: 0 8px 32px rgba(61, 46, 36, 0.08);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--warm-cream);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* =============================================
           ANIMATED THREAD BACKGROUND
        ============================================= */
        .thread-bg {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
            opacity: 0.08;
        }

        .thread-line {
            position: absolute;
            height: 1px;
            background: var(--golden-thread);
            transform-origin: left center;
            animation: threadWeave 20s ease-in-out infinite;
        }

        .thread-line:nth-child(1) { top: 15%; width: 80%; left: -10%; animation-delay: 0s; }
        .thread-line:nth-child(2) { top: 35%; width: 90%; left: 5%; animation-delay: -4s; }
        .thread-line:nth-child(3) { top: 55%; width: 70%; left: -5%; animation-delay: -8s; }
        .thread-line:nth-child(4) { top: 75%; width: 85%; left: 10%; animation-delay: -12s; }
        .thread-line:nth-child(5) { top: 90%; width: 75%; left: -8%; animation-delay: -16s; }

        @keyframes threadWeave {
            0%, 100% { transform: rotate(0.5deg) scaleX(1); opacity: 0.3; }
            25% { transform: rotate(-0.3deg) scaleX(1.05); opacity: 0.6; }
            50% { transform: rotate(0.8deg) scaleX(0.95); opacity: 0.4; }
            75% { transform: rotate(-0.5deg) scaleX(1.02); opacity: 0.7; }
        }

        /* =============================================
           SCREEN MANAGEMENT
        ============================================= */
        .screen {
            display: none;
            position: relative;
            z-index: 1;
        }

        .screen.active {
            display: block;
            animation: screenIn 0.5s ease;
        }

        @keyframes screenIn {
            from { opacity: 0; transform: translateY(16px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* =============================================
           SHARED COMPONENTS
        ============================================= */
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
        }

        .container-narrow {
            max-width: 520px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
        }

        .card {
            background: white;
            border-radius: 24px;
            padding: 2.5rem;
            box-shadow: var(--card-shadow);
            margin-bottom: 2rem;
        }

        .logo-header {
            text-align: center;
            padding: 2rem 0 0.5rem;
            cursor: pointer;
        }

        .logo-header:hover { opacity: 0.85; }

        .logo-symbol {
            font-size: 3rem;
            color: var(--brand-red);
            font-weight: 300;
            font-family: 'Crimson Pro', serif;
        }

        .logo-text {
            font-size: 1.25rem;
            color: var(--text-secondary);
            font-weight: 300;
            letter-spacing: 0.15em;
            font-family: 'DM Sans', sans-serif;
        }

        h1 {
            font-family: 'Crimson Pro', serif;
            font-size: 2rem;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
            text-align: center;
            font-weight: 600;
        }

        h2 {
            font-family: 'Crimson Pro', serif;
            font-size: 1.5rem;
            color: var(--text-primary);
            font-weight: 600;
        }

        .subtitle {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 2rem;
            font-size: 0.95rem;
        }

        /* Buttons */
        .btn {
            display: inline-block;
            padding: 0.875rem 1.5rem;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
            text-align: center;
            text-decoration: none;
            font-family: 'DM Sans', sans-serif;
        }

        .btn-primary {
            background: var(--brand-red);
            color: white;
        }

        .btn-primary:hover {
            background: var(--brand-red-hover);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(200, 90, 62, 0.25);
        }

        .btn-secondary {
            background: white;
            color: var(--text-primary);
            border: 2px solid var(--border-light);
        }

        .btn-secondary:hover {
            border-color: var(--golden-thread);
            color: var(--golden-thread);
        }

        .btn-full { width: 100%; }
        .btn-group { display: flex; gap: 1rem; margin-top: 2rem; }
        .btn-group .btn { flex: 1; }

        /* Forms */
        .form-group { margin-bottom: 1.5rem; }

        label {
            display: block;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        .required { color: var(--brand-red); }

        input[type="text"],
        input[type="email"],
        input[type="password"],
        input[type="tel"],
        input[type="url"],
        textarea {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--border-light);
            border-radius: 12px;
            font-family: 'DM Sans', sans-serif;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
            color: var(--text-primary);
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: var(--golden-thread);
            box-shadow: 0 0 0 3px rgba(176, 137, 104, 0.1);
        }

        textarea { min-height: 100px; resize: vertical; }

        .hint {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }

        .text-link {
            text-align: center;
            margin-top: 1.5rem;
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .text-link a {
            color: var(--brand-red);
            text-decoration: none;
            font-weight: 600;
        }

        .text-link a:hover { text-decoration: underline; }

        /* Identity cards */
        .identity-card {
            background: var(--soft-sand);
            border: 2px solid var(--border-light);
            border-radius: 16px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }

        .identity-card:hover {
            border-color: var(--golden-thread);
            transform: translateX(4px);
            box-shadow: 0 4px 16px rgba(61, 46, 36, 0.08);
        }

        .identity-icon { font-size: 2rem; margin-bottom: 0.5rem; }
        .identity-title { font-size: 1.15rem; font-weight: 600; margin-bottom: 0.25rem; }
        .identity-desc { font-size: 0.9rem; color: var(--text-secondary); }

        /* Social auth buttons */
        .btn-social {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            padding: 1rem;
            border-radius: 12px;
            border: 2px solid var(--border-light);
            background: white;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
            font-family: 'DM Sans', sans-serif;
        }

        .btn-social:hover {
            border-color: var(--golden-thread);
            transform: translateY(-2px);
        }

        .divider {
            display: flex;
            align-items: center;
            margin: 2rem 0;
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .divider::before, .divider::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid var(--border-light);
        }

        .divider span { padding: 0 1rem; }

        /* Password toggle */
        .password-toggle { position: relative; }

        .password-toggle-btn {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.25rem;
            color: var(--text-muted);
        }

        /* Verification code */
        .code-inputs {
            display: flex;
            gap: 0.75rem;
            justify-content: center;
            margin: 2rem 0;
        }

        .code-input {
            width: 52px;
            height: 60px;
            text-align: center;
            font-size: 1.5rem;
            font-weight: 700;
            border: 2px solid var(--border-light);
            border-radius: 12px;
            font-family: 'DM Sans', sans-serif;
            background: white;
            color: var(--text-primary);
            transition: all 0.2s ease;
            caret-color: var(--brand-red);
        }

        .code-input:focus {
            border-color: var(--brand-red);
            outline: none;
            box-shadow: 0 0 0 3px rgba(200, 90, 62, 0.1);
            transform: translateY(-2px);
        }

        .code-input.filled {
            border-color: var(--golden-thread);
            background: var(--soft-sand);
        }

        .code-input.error {
            border-color: #e53935;
            background: #fff5f5;
            animation: codeShake 0.4s ease;
        }

        .code-input.success {
            border-color: var(--sage);
            background: #f0faf4;
        }

        @keyframes codeShake {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-6px); }
            40% { transform: translateX(6px); }
            60% { transform: translateX(-4px); }
            80% { transform: translateX(4px); }
        }

        /* Verification states */
        .verify-status {
            text-align: center;
            margin: 1rem 0;
            font-size: 0.9rem;
            min-height: 1.5rem;
            transition: all 0.3s ease;
        }

        .verify-status.error { color: #e53935; }
        .verify-status.success { color: var(--sage); font-weight: 600; }

        .verify-loading {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-muted);
        }

        .verify-spinner {
            width: 18px;
            height: 18px;
            border: 2px solid var(--border-light);
            border-top-color: var(--brand-red);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .resend-timer {
            text-align: center;
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-top: 1.25rem;
        }

        .resend-btn {
            color: var(--brand-red);
            cursor: pointer;
            font-weight: 600;
            background: none;
            border: none;
            font-family: 'DM Sans', sans-serif;
            font-size: inherit;
            text-decoration: none;
        }

        .resend-btn:hover { text-decoration: underline; }
        .resend-btn:disabled { color: var(--text-muted); cursor: default; text-decoration: none; }

        .email-sent-animation {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .email-icon-animated {
            font-size: 3.5rem;
            animation: emailBounce 0.6s ease;
        }

        @keyframes emailBounce {
            0% { transform: scale(0) rotate(-10deg); opacity: 0; }
            50% { transform: scale(1.2) rotate(5deg); opacity: 1; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        .demo-code-hint {
            background: linear-gradient(135deg, #fffbf0, #fff8f0);
            border: 1px dashed var(--golden-thread);
            border-radius: 12px;
            padding: 0.75rem 1rem;
            margin: 1.25rem 0;
            font-size: 0.85rem;
            color: var(--warm-brown);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .demo-code-hint code {
            background: white;
            padding: 0.2rem 0.6rem;
            border-radius: 6px;
            font-weight: 700;
            font-size: 1rem;
            letter-spacing: 0.15em;
            color: var(--brand-red);
            border: 1px solid var(--border-light);
        }

        .verify-success-overlay {
            position: absolute;
            inset: 0;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            animation: fadeIn 0.3s ease;
        }

        .checkmark-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--sage);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1.25rem;
            animation: checkPop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .checkmark-circle svg {
            width: 40px;
            height: 40px;
            stroke: white;
            stroke-width: 3;
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .checkmark-circle svg path {
            stroke-dasharray: 50;
            stroke-dashoffset: 50;
            animation: checkDraw 0.4s ease 0.3s forwards;
        }

        @keyframes checkPop {
            0% { transform: scale(0); }
            80% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes checkDraw {
            to { stroke-dashoffset: 0; }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* =============================================
           BUSINESS LOCKOUT & PRIVACY
        ============================================= */
        .analytics-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 0.75rem;
            margin: 1.5rem 0 2rem;
        }

        .analytics-stat {
            background: var(--soft-sand);
            border-radius: 14px;
            padding: 1rem;
            text-align: center;
            border: 1px solid var(--border-light);
        }

        .analytics-stat-number {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--brand-red);
            font-family: 'Crimson Pro', serif;
        }

        .analytics-stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 0.15rem;
        }

        .privacy-shield {
            position: relative;
            background: linear-gradient(135deg, #f8f4f1 0%, #f0ebe6 100%);
            border: 2px solid var(--border-light);
            border-radius: 20px;
            padding: 2.5rem 2rem;
            text-align: center;
            margin: 1.5rem 0;
            overflow: hidden;
        }

        .privacy-shield::before {
            content: '';
            position: absolute;
            inset: 0;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                rgba(176, 137, 104, 0.03) 10px,
                rgba(176, 137, 104, 0.03) 20px
            );
            pointer-events: none;
        }

        .shield-icon {
            width: 64px;
            height: 64px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 1.75rem;
            box-shadow: 0 4px 16px rgba(61, 46, 36, 0.08);
            border: 2px solid var(--border-light);
        }

        .privacy-shield h3 {
            font-family: 'Crimson Pro', serif;
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            position: relative;
        }

        .privacy-shield p {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.6;
            max-width: 380px;
            margin: 0 auto;
            position: relative;
        }

        .privacy-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            background: white;
            border: 1px solid var(--border-light);
            border-radius: 20px;
            padding: 0.35rem 0.85rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--warm-brown);
            margin-top: 1rem;
            position: relative;
        }

        .privacy-badge-dot {
            width: 6px;
            height: 6px;
            background: var(--sage);
            border-radius: 50%;
        }

        .blurred-preview {
            position: relative;
            margin: 1.5rem 0;
            border-radius: 16px;
            overflow: hidden;
        }

        .blurred-content {
            filter: blur(12px);
            opacity: 0.3;
            pointer-events: none;
            user-select: none;
            padding: 1.25rem;
            background: var(--soft-sand);
            border-radius: 16px;
        }

        .blurred-content .fake-line {
            height: 10px;
            background: var(--border-light);
            border-radius: 5px;
            margin-bottom: 0.6rem;
        }

        .blurred-content .fake-line:nth-child(1) { width: 40%; }
        .blurred-content .fake-line:nth-child(2) { width: 90%; }
        .blurred-content .fake-line:nth-child(3) { width: 75%; }
        .blurred-content .fake-line:nth-child(4) { width: 60%; }

        .blurred-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .blurred-lock {
            background: white;
            border-radius: 12px;
            padding: 0.6rem 1.25rem;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--warm-brown);
            box-shadow: 0 4px 16px rgba(61, 46, 36, 0.1);
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .biz-owner-banner {
            background: linear-gradient(135deg, #3D2E24 0%, #5D4E44 100%);
            color: white;
            border-radius: 14px;
            padding: 1rem 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
        }

        .biz-owner-banner-icon {
            width: 36px;
            height: 36px;
            background: rgba(255,255,255,0.15);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            flex-shrink: 0;
        }

        .biz-owner-banner-text { flex: 1; }
        .biz-owner-banner-label { font-weight: 600; font-size: 0.85rem; }
        .biz-owner-banner-sub { font-size: 0.8rem; opacity: 0.7; }

        /* =============================================
           BUSINESS PROFILE & CLAIM FLOW
        ============================================= */
        .profile-summary {
            background: var(--soft-sand);
            border: 2px solid var(--border-light);
            border-radius: 20px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            gap: 1.25rem;
            align-items: flex-start;
        }

        .profile-avatar {
            width: 64px;
            height: 64px;
            background: white;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
            flex-shrink: 0;
            border: 2px solid var(--border-light);
        }

        .profile-info { flex: 1; min-width: 0; }

        .profile-name {
            font-family: 'Crimson Pro', serif;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.15rem;
        }

        .profile-detail {
            font-size: 0.85rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.35rem;
            margin-top: 0.2rem;
        }

        .profile-links {
            display: flex;
            gap: 0.4rem;
            margin-top: 0.5rem;
            flex-wrap: wrap;
        }

        .profile-link-pill {
            background: white;
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 0.2rem 0.6rem;
            font-size: 0.75rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .profile-edit-btn {
            padding: 0.5rem 0.75rem;
            font-size: 0.8rem;
            border-radius: 10px;
            border: 2px solid var(--border-light);
            background: white;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-secondary);
            font-family: 'DM Sans', sans-serif;
            transition: all 0.2s;
            flex-shrink: 0;
            align-self: flex-start;
        }

        .profile-edit-btn:hover { border-color: var(--golden-thread); color: var(--golden-thread); }

        /* Template cards */
        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .template-card {
            background: white;
            border: 2px solid var(--border-light);
            border-radius: 16px;
            padding: 1.25rem;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .template-card:hover {
            border-color: var(--golden-thread);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(61, 46, 36, 0.08);
        }

        .template-card.selected {
            border-color: var(--golden-thread);
            background: #fff8f5;
            box-shadow: 0 0 0 3px rgba(200, 90, 62, 0.1);
        }

        .template-card.selected::after {
            content: '✓';
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            width: 24px;
            height: 24px;
            background: var(--brand-red);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .template-icon { font-size: 2rem; margin-bottom: 0.5rem; }

        .template-name {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }

        .template-desc {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .template-meta {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
            flex-wrap: wrap;
        }

        .template-meta-pill {
            font-size: 0.7rem;
            background: var(--soft-sand);
            padding: 0.15rem 0.5rem;
            border-radius: 6px;
            color: var(--text-muted);
        }

        .template-add-card {
            background: var(--soft-sand);
            border: 2px dashed var(--border-light);
            border-radius: 16px;
            padding: 1.25rem;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 140px;
        }

        .template-add-card:hover {
            border-color: var(--golden-thread);
            background: white;
        }

        .template-add-icon {
            font-size: 2rem;
            color: var(--text-muted);
            margin-bottom: 0.4rem;
        }

        .template-add-label {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        /* Claim confirmation */
        .claim-preview {
            background: white;
            border: 2px solid var(--border-light);
            border-radius: 16px;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }

        .claim-preview-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: var(--text-muted);
            font-weight: 600;
            margin-bottom: 0.75rem;
        }

        .claim-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            font-size: 0.9rem;
        }

        .claim-row + .claim-row { border-top: 1px solid var(--border-light); }

        .claim-row-label { color: var(--text-muted); }
        .claim-row-value { font-weight: 600; }

        /* Upload areas */
        .upload-area {
            border: 2px dashed var(--border-light);
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--soft-sand);
        }

        .upload-area:hover {
            border-color: var(--golden-thread);
            background: white;
        }

        .upload-icon { font-size: 2.5rem; margin-bottom: 0.75rem; }

        .previews {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .preview-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid var(--border-light);
        }

        .preview-item img, .preview-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .preview-remove {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: rgba(255,255,255,0.95);
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            line-height: 26px;
        }

        .preview-remove:hover { background: var(--brand-red); color: white; }

        .preview-badge {
            position: absolute;
            bottom: 0.5rem;
            left: 0.5rem;
            background: rgba(61, 46, 36, 0.9);
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 6px;
            font-size: 0.7rem;
        }

        /* Links */
        .link-row { display: flex; gap: 0.5rem; margin-bottom: 0.75rem; }
        .link-row input { flex: 1; }

        .btn-icon {
            width: 42px;
            height: 42px;
            border-radius: 10px;
            border: 2px solid var(--border-light);
            background: white;
            cursor: pointer;
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .btn-icon:hover { border-color: var(--golden-thread); }

        /* File items */
        .file-item {
            background: var(--soft-sand);
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .file-icon { font-size: 1.75rem; }
        .file-info { flex: 1; }
        .file-name { font-weight: 600; font-size: 0.9rem; }
        .file-size { font-size: 0.8rem; color: var(--text-muted); }

        /* Content display */
        .business-header {
            border-bottom: 2px solid var(--border-light);
            padding-bottom: 1.5rem;
            margin-bottom: 2rem;
        }

        .business-name { font-family: 'Crimson Pro', serif; font-size: 1.75rem; font-weight: 600; margin-bottom: 0.5rem; }
        .product-name { font-size: 1.1rem; color: var(--text-secondary); margin-bottom: 1rem; }
        .description { color: var(--text-secondary); line-height: 1.8; }

        .section-title {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            margin: 2rem 0 1rem;
            font-weight: 600;
        }

        .contact-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .contact-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            background: var(--soft-sand);
            border-radius: 12px;
        }

        .contact-icon { font-size: 1.3rem; }
        .contact-label { font-size: 0.8rem; color: var(--text-muted); }
        .contact-value { font-weight: 600; font-size: 0.95rem; }

        .link-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            background: var(--soft-sand);
            border-radius: 12px;
            margin-bottom: 0.75rem;
            text-decoration: none;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .link-item:hover { background: var(--blush); transform: translateX(4px); }

        .media-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .media-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 16px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .media-item:hover { transform: scale(1.03); }

        .media-item img, .media-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .media-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.95);
            padding: 0.35rem 0.6rem;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .message-block {
            background: var(--soft-sand);
            border-left: 4px solid var(--golden-thread);
            border-radius: 0 16px 16px 0;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }

        .message-from {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
            font-weight: 600;
        }

        .message-text {
            font-family: 'Crimson Pro', serif;
            font-size: 1.2rem;
            font-style: italic;
            line-height: 1.7;
            color: var(--text-primary);
        }

        .action-section {
            background: var(--soft-sand);
            border: 2px solid var(--border-light);
            border-radius: 16px;
            padding: 1.75rem;
            margin-top: 2rem;
            text-align: center;
        }

        .action-title { font-weight: 600; font-size: 1.05rem; margin-bottom: 0.25rem; }
        .action-subtitle { color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1.25rem; }

        .success-icon { text-align: center; font-size: 4rem; margin-bottom: 1.5rem; }

        /* Alert styles */
        .alert {
            padding: 1rem 1.25rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
        }

        .alert-info { background: #e3f2fd; color: #1565c0; border-left: 4px solid #2196f3; }

        /* =============================================
           STICKY HEADER (Tapestry + Thread views)
        ============================================= */
        .app-header {
            background: rgba(253, 248, 245, 0.95);
            backdrop-filter: blur(12px);
            padding: 1rem 0;
            box-shadow: 0 2px 12px rgba(61, 46, 36, 0.06);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-inner {
            max-width: 900px;
            margin: 0 auto;
            padding: 0 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-logo {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            text-decoration: none;
        }

        .header-logo:hover { opacity: 0.8; }

        .header-logo .logo-symbol { font-size: 2rem; }
        .header-logo .logo-text { font-size: 1rem; letter-spacing: 0.12em; }

        .header-actions { display: flex; gap: 10px; align-items: center; }

        .header-search {
            padding: 0.6rem 1rem;
            border: 2px solid var(--border-light);
            border-radius: 25px;
            font-size: 0.875rem;
            width: 200px;
            transition: all 0.3s;
            font-family: 'DM Sans', sans-serif;
            background: white;
        }

        .header-search:focus {
            outline: none;
            border-color: var(--golden-thread);
            width: 260px;
        }

        .header-btn {
            padding: 0.6rem 1rem;
            border-radius: 10px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.3s;
            font-family: 'DM Sans', sans-serif;
        }

        .header-btn-primary {
            background: var(--brand-red);
            color: white;
        }

        .header-btn-primary:hover { background: var(--brand-red-hover); }

        .header-btn-ghost {
            background: transparent;
            color: var(--text-secondary);
            border: 2px solid var(--border-light);
        }

        .header-btn-ghost:hover { border-color: var(--golden-thread); }

        /* =============================================
           WELCOME / INTRO VIEW
        ============================================= */
        #welcomeScreen.active {
            display: flex;
            min-height: 100vh;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .welcome-card {
            max-width: 640px;
            background: white;
            border-radius: 28px;
            padding: 3.5rem 3rem;
            box-shadow: var(--card-shadow);
            text-align: center;
        }

        .welcome-logo {
            margin-bottom: 2rem;
        }

        .welcome-logo .logo-symbol { font-size: 4rem; }
        .welcome-logo .logo-text { font-size: 1.5rem; margin-top: 0.25rem; }

        .welcome-tagline {
            font-family: 'Crimson Pro', serif;
            font-size: 1.15rem;
            color: var(--text-muted);
            font-style: italic;
            margin-bottom: 2.5rem;
        }

        .welcome-body { text-align: left; margin-bottom: 2.5rem; }

        .welcome-body p {
            font-size: 1rem;
            line-height: 1.8;
            color: var(--text-secondary);
            margin-bottom: 1.25rem;
        }

        .welcome-body em {
            color: var(--brand-red);
            font-style: italic;
            font-weight: 600;
        }

        .highlight-box {
            background: linear-gradient(135deg, var(--soft-sand) 0%, var(--blush) 100%);
            border-left: 4px solid var(--golden-thread);
            padding: 1.5rem;
            border-radius: 0 14px 14px 0;
            margin: 1.75rem 0;
        }

        .highlight-box p {
            font-size: 0.95rem;
            line-height: 1.7;
            color: var(--text-primary);
            margin: 0;
        }

        .welcome-actions {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            align-items: center;
        }

        .welcome-actions .btn { min-width: 260px; }

        .welcome-footer {
            margin-top: 2rem;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* =============================================
           TAPESTRY VIEW
        ============================================= */
        .tapestry-welcome {
            text-align: center;
            margin-bottom: 2.5rem;
            padding-top: 1rem;
        }

        .tapestry-welcome h1 {
            font-size: 2.25rem;
            margin-bottom: 0.5rem;
        }

        .stats-row {
            display: flex;
            justify-content: center;
            gap: 3rem;
            margin-top: 1.5rem;
        }

        .stat { text-align: center; }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--brand-red);
            font-family: 'Crimson Pro', serif;
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Filter tabs */
        .filter-tabs {
            display: flex;
            gap: 0.75rem;
            justify-content: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .filter-tab {
            padding: 0.6rem 1.25rem;
            background: white;
            border: 2px solid var(--border-light);
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 0.875rem;
            font-family: 'DM Sans', sans-serif;
        }

        .filter-tab:hover { border-color: var(--golden-thread); color: var(--golden-thread); }

        .filter-tab.active {
            background: var(--brand-red);
            color: white;
            border-color: var(--brand-red);
        }

        /* Thread cards grid */
        .threads-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2.5rem;
        }

        .thread-card {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(61, 46, 36, 0.06);
            transition: all 0.3s;
            cursor: pointer;
        }

        .thread-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 28px rgba(61, 46, 36, 0.12);
        }

        .thread-card-image {
            width: 100%;
            height: 180px;
            background: linear-gradient(135deg, var(--soft-sand), var(--blush));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3.5rem;
        }

        .thread-card-body { padding: 1.25rem; }

        .thread-card-category {
            display: inline-block;
            padding: 0.2rem 0.7rem;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 0.6rem;
        }

        .cat-thing { background: #FFE8E0; color: var(--brand-red); }
        .cat-person { background: #E0F2E9; color: var(--sage); }
        .cat-place { background: #E8E0F2; color: #7B68B0; }

        .thread-card-title {
            font-family: 'Crimson Pro', serif;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.4rem;
        }

        .thread-card-from { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.6rem; }

        .thread-card-msg {
            font-size: 0.875rem;
            color: var(--text-secondary);
            line-height: 1.6;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .thread-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 0.75rem;
            margin-top: 0.75rem;
            border-top: 1px solid var(--border-light);
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .thread-tags { display: flex; gap: 0.4rem; flex-wrap: wrap; margin-top: 0.5rem; }

        .tag {
            padding: 0.15rem 0.6rem;
            background: var(--soft-sand);
            border-radius: 8px;
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        /* Tapestry empty state */
        .tapestry-empty {
            text-align: center;
            padding: 4rem 2rem;
        }

        .tapestry-empty h2 { margin-bottom: 0.75rem; }
        .tapestry-empty p { color: var(--text-secondary); margin-bottom: 2rem; max-width: 400px; margin-left: auto; margin-right: auto; }

        /* Timeline section */
        .timeline-section {
            margin-top: 3rem;
            padding-top: 2.5rem;
            border-top: 2px solid var(--border-light);
        }

        .timeline-section h2 { text-align: center; margin-bottom: 0.5rem; }
        .timeline-subtitle { text-align: center; color: var(--text-muted); margin-bottom: 2rem; font-size: 0.95rem; }

        .timeline-scroll {
            display: flex;
            overflow-x: auto;
            gap: 1.25rem;
            padding: 2rem 0.5rem 2.5rem;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        .timeline-scroll::-webkit-scrollbar { height: 6px; }
        .timeline-scroll::-webkit-scrollbar-track { background: var(--soft-sand); border-radius: 3px; }
        .timeline-scroll::-webkit-scrollbar-thumb { background: var(--golden-thread); border-radius: 3px; }

        .timeline-card {
            min-width: 240px;
            max-width: 240px;
            background: white;
            border-radius: 16px;
            padding: 1.25rem;
            box-shadow: 0 4px 16px rgba(61, 46, 36, 0.06);
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            flex-shrink: 0;
        }

        .timeline-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(61, 46, 36, 0.12);
        }

        .timeline-date {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--brand-red);
            margin-bottom: 0.15rem;
        }

        .timeline-day {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 0.75rem;
        }

        .timeline-icon { font-size: 2.25rem; margin-bottom: 0.75rem; opacity: 0.8; }

        .timeline-title {
            font-family: 'Crimson Pro', serif;
            font-size: 1.05rem;
            font-weight: 600;
            margin-bottom: 0.4rem;
        }

        .timeline-from { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.5rem; }

        .timeline-msg {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Floating scan button */
        .fab {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            background: var(--brand-red);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 6px 24px rgba(200, 90, 62, 0.35);
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            z-index: 50;
        }

        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 32px rgba(200, 90, 62, 0.45);
        }

        /* =============================================
           RESPONSIVE
        ============================================= */
        @media (max-width: 768px) {
            .welcome-card { padding: 2.5rem 1.75rem; }
            .card { padding: 1.75rem; }
            .container { padding: 1.5rem 1rem; }
            .container-narrow { padding: 1.5rem 1rem; }
            .btn-group { flex-direction: column; }
            .stats-row { gap: 1.5rem; }
            .threads-grid { grid-template-columns: 1fr; }
            .header-search { width: 140px; }
            .header-search:focus { width: 180px; }
            .header-actions { gap: 6px; }
            .header-btn { padding: 0.5rem 0.75rem; font-size: 0.8rem; }
            h1 { font-size: 1.75rem; }
            .link-row { flex-direction: column; }
            .contact-grid { grid-template-columns: 1fr; }
        }

        @media (max-width: 480px) {
            .header-search { display: none; }
            .welcome-card { padding: 2rem 1.25rem; }
            .welcome-actions .btn { min-width: 100%; }
        }
        /* ========================
           QR SCANNER OVERLAY
        ======================== */
        .scanner-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #000;
            z-index: 9999;
            display: none;
            flex-direction: column;
        }

        .scanner-overlay.active { display: flex; }

        .scanner-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.25rem;
            background: rgba(0,0,0,0.8);
            color: white;
            position: relative;
            z-index: 2;
        }

        .scanner-header h3 {
            font-family: 'DM Sans', sans-serif;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .scanner-close {
            background: rgba(255,255,255,0.15);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.25rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .scanner-viewfinder {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        #qr-reader {
            width: 100%;
            max-width: 500px;
        }

        #qr-reader video { border-radius: 12px; }

        .scanner-hint {
            padding: 1.25rem;
            text-align: center;
            color: rgba(255,255,255,0.7);
            font-size: 0.9rem;
            background: rgba(0,0,0,0.8);
        }

        .scanner-manual {
            margin-top: 0.75rem;
        }

        .scanner-manual input {
            padding: 10px 14px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 0.9rem;
            width: 200px;
            font-family: inherit;
        }

        .scanner-manual input::placeholder { color: rgba(255,255,255,0.4); }

        .scanner-manual button {
            padding: 10px 18px;
            border-radius: 10px;
            border: none;
            background: var(--brand-red);
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            margin-left: 6px;
            font-family: inherit;
        }

        /* ========================
           EXTERNAL QR NOTE PAGE
        ======================== */
        .external-qr-url {
            background: var(--soft-sand);
            border: 2px solid var(--border-light);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            word-break: break-all;
            font-size: 0.85rem;
            color: var(--text-secondary);
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
        }

        .external-qr-url .url-icon { font-size: 1.25rem; flex-shrink: 0; }

        .category-picker {
            display: flex;
            gap: 10px;
            margin-top: 0.5rem;
        }

        .category-option {
            flex: 1;
            padding: 14px 10px;
            border: 2px solid var(--border-light);
            border-radius: 14px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }

        .category-option:hover {
            border-color: var(--golden-thread);
        }

        .category-option.selected {
            border-color: var(--brand-red);
            background: #FFF5F2;
        }

        .category-option .cat-icon { font-size: 1.75rem; display: block; margin-bottom: 4px; }
        .category-option .cat-label { font-size: 0.8rem; font-weight: 600; color: var(--text-primary); }

        .photo-preview-grid {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 0.75rem;
        }

        .photo-preview-item {
            width: 80px;
            height: 80px;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            border: 2px solid var(--border-light);
        }

        .photo-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-preview-item .remove-photo {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 22px;
            height: 22px;
            background: rgba(0,0,0,0.6);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ========================
           THREAD DETAIL
        ======================== */
        .thread-detail-hero {
            text-align: center;
            padding: 2rem 0 1.5rem;
        }

        .thread-detail-icon {
            font-size: 3.5rem;
            margin-bottom: 0.5rem;
        }

        .thread-detail-title {
            font-family: 'Crimson Pro', serif;
            font-size: 1.75rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .thread-detail-meta {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .thread-detail-card {
            background: white;
            border-radius: 20px;
            padding: 1.75rem;
            box-shadow: var(--card-shadow);
            margin-bottom: 1.25rem;
        }

        .thread-detail-card h3 {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
            font-weight: 600;
        }

        .thread-detail-message {
            font-size: 1.05rem;
            line-height: 1.7;
            color: var(--text-primary);
        }

        .thread-detail-photos {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
        }

        .thread-detail-photos img {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            border-radius: 12px;
            border: 2px solid var(--border-light);
            cursor: pointer;
        }

        .thread-detail-url {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 1rem;
            background: var(--soft-sand);
            border-radius: 12px;
            text-decoration: none;
            color: var(--text-primary);
            transition: all 0.2s;
            word-break: break-all;
        }

        .thread-detail-url:hover {
            background: var(--blush);
        }

        .thread-detail-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .thread-detail-tags .tag {
            background: var(--soft-sand);
            color: var(--text-secondary);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        /* External scan landing */
        .scan-landing-url {
            background: white;
            border: 2px solid var(--border-light);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            margin-bottom: 1.5rem;
            word-break: break-all;
        }

        .scan-landing-url .url-text {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 0.75rem;
            line-height: 1.5;
        }

    </style>
</head>
<body>

<!-- Thread Background -->
<div class="thread-bg">
    <div class="thread-line"></div>
    <div class="thread-line"></div>
    <div class="thread-line"></div>
    <div class="thread-line"></div>
    <div class="thread-line"></div>
</div>

<!-- =============================================
     SCREEN 1: WELCOME (duyen.io — not logged in)
============================================= -->
<div class="screen" id="welcomeScreen">
    <div class="welcome-card">
        <div class="welcome-logo">
            <div class="logo-symbol">緣</div>
            <div class="logo-text">DUYÊN</div>
        </div>
        <div class="welcome-tagline">The tapestry of your life</div>

        <div class="welcome-body">
            <p>In Vietnamese, <em>duyên</em> (緣) describes the invisible threads connecting us to the people, places, and things that shape our lives. It speaks to the beautiful notion that some connections are meant to be — woven by fate, chance, and the choices we make.</p>

            <p>Every gift holds a story. Every person leaves their mark. Every place becomes part of your journey. Yet these precious moments often fade from memory, their stories untold, their meaning lost to time.</p>

            <div class="highlight-box">
                <p><strong>Duyên preserves what matters.</strong> Each time you scan a Duyên code, you create a thread — a lasting memory of a gift received, a person met, or a place discovered. Together, these threads weave the tapestry of your life.</p>
            </div>
        </div>

        <div class="welcome-actions">
            <button class="btn btn-primary" onclick="navigate('auth')">Sign In to Your Tapestry</button>
            <button class="btn btn-secondary" onclick="navigate('tapestry')">Continue as Guest</button>
        </div>

        <div class="welcome-footer">Your first thread is just a scan away</div>
    </div>
</div>

<!-- =============================================
     SCREEN 2: QR SCAN LANDING (duyen.io/q/CODE)
============================================= -->
<div class="screen" id="qrIdentityScreen">
    <div class="container-narrow">
        <div class="logo-header" onclick="navigate('home')">
            <div class="logo-symbol">緣</div>
            <div class="logo-text">DUYÊN</div>
        </div>
        <div class="card">
            <h1>A Thread Awaits</h1>
            <p class="subtitle">Someone wove a connection into this code. What's your role in this story?</p>

            <div id="roleBusinessOption" class="identity-card" onclick="selectRole('business')">
                <div class="identity-icon">🏢</div>
                <div class="identity-title">I'm the Business</div>
                <div class="identity-desc">Add your business information, photos, videos, and links</div>
            </div>

            <div class="identity-card" onclick="selectRole('giver')">
                <div class="identity-icon">🎁</div>
                <div class="identity-title">I'm Giving a Gift</div>
                <div class="identity-desc">Add your personal message, photos, and videos</div>
            </div>

            <div class="identity-card" onclick="selectRole('receiver')">
                <div class="identity-icon">💝</div>
                <div class="identity-title">I Received This</div>
                <div class="identity-desc">View the gift and save it to your tapestry</div>
            </div>
        </div>
        <div id="qrNotFound" style="display: none;">
            <div class="card" style="text-align: center; padding: 2rem 0;">
                <div style="font-size: 2.5rem; margin-bottom: 1rem;">🔍</div>
                <h2 style="font-family: 'Crimson Pro', serif;">Thread Not Found</h2>
                <p style="color: var(--text-muted);">This QR code hasn't been set up yet.</p>
                <button class="btn btn-primary" onclick="navigate('home')" style="margin-top: 1rem;">Go Home</button>
            </div>
        </div>
    </div>
</div>

<!-- =============================================
     SCREEN 2B: QR CONTENT VIEW (after role selection)
============================================= -->
<div class="screen" id="qrContentScreen">
    <div class="container-narrow">
        <div class="logo-header" onclick="navigate('home')">
            <div class="logo-symbol">緣</div>
            <div class="logo-text">DUYÊN</div>
        </div>
        <div class="card">
            <!-- Business info section (shows if business data exists) -->
            <div id="qcBizSection" style="display: none;">
                <div id="qcBizPhoto" style="display: none; margin-bottom: 1.5rem; text-align: center;">
                    <img id="qcBizPhotoImg" src="" alt="Photo" style="max-width: 100%; border-radius: 16px; border: 2px solid var(--border-light);">
                </div>
                <h1 id="qcBizLabel" style="font-family: 'Crimson Pro', serif; font-size: 1.75rem;"></h1>
                <p id="qcBizDetails" class="subtitle" style="white-space: pre-wrap;"></p>
                <div id="qcBizMedia" class="thread-detail-photos" style="display: none; margin-top: 1rem;"></div>
                <hr style="border: none; border-top: 1px solid var(--border-light); margin: 1.5rem 0;">
            </div>
            
            <!-- Giver section: shows when role=giver and no giver data yet -->
            <div id="qcGiverForm" style="display: none;">
                <h2 style="font-family: 'Crimson Pro', serif; font-size: 1.4rem; margin-bottom: 0.5rem;">Add Your Gift Message</h2>
                <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1rem;">Write a personal message for the person receiving this gift.</p>
                <textarea id="qcGiverMessage" placeholder="Write your heartfelt message here..." style="width: 100%; min-height: 120px; border: 2px solid var(--border-light); border-radius: 12px; padding: 1rem; font-family: inherit; font-size: 1rem; resize: vertical; box-sizing: border-box;"></textarea>
                <div style="margin-top: 1rem;">
                    <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem;">Add Photos (optional)</label>
                    <input type="file" id="qcGiverPhotos" accept="image/*" multiple onchange="handleGiverPhotos(this)" style="font-size: 0.9rem;">
                    <div id="qcGiverPhotoPreview" style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 0.75rem;"></div>
                </div>
                <button class="btn btn-primary" onclick="saveGiverData()" style="width: 100%; margin-top: 1.5rem;">🎁 Send Gift Message</button>
            </div>
            
            <!-- Giver view: shows when role=giver and giver data exists (waiting for response) -->
            <div id="qcGiverSent" style="display: none; text-align: center; padding: 1rem 0;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">🎁</div>
                <h2 style="font-family: 'Crimson Pro', serif;">Your Gift Message</h2>
                <div id="qcGiverSentMessage" style="background: var(--soft-sand); padding: 1.25rem; border-radius: 14px; margin: 1rem 0; text-align: left; white-space: pre-wrap;"></div>
                <div id="qcReceiverResponse" style="display: none;">
                    <h3 style="font-family: 'Crimson Pro', serif; margin-top: 1.5rem;">💝 Response from Receiver</h3>
                    <div id="qcReceiverMessage" style="background: #FFF5F2; padding: 1.25rem; border-radius: 14px; margin: 1rem 0; text-align: left; white-space: pre-wrap;"></div>
                </div>
                <div id="qcGiverWaiting" style="margin-top: 1rem; color: var(--text-muted); font-size: 0.9rem;">
                    Waiting for a response from the receiver...
                </div>
            </div>
            
            <!-- Receiver section: shows when role=receiver -->
            <div id="qcReceiverView" style="display: none;">
                <div id="qcGiverMessageView" style="display: none;">
                    <h2 style="font-family: 'Crimson Pro', serif; font-size: 1.4rem; margin-bottom: 0.5rem;">🎁 A Gift For You</h2>
                    <div id="qcGiverMsgContent" style="background: var(--soft-sand); padding: 1.25rem; border-radius: 14px; margin: 1rem 0; white-space: pre-wrap;"></div>
                    <div id="qcGiverMsgPhotos" class="thread-detail-photos" style="display: none; margin-bottom: 1rem;"></div>
                    <hr style="border: none; border-top: 1px solid var(--border-light); margin: 1.5rem 0;">
                </div>
                <div id="qcReceiverForm" style="display: none;">
                    <h2 style="font-family: 'Crimson Pro', serif; font-size: 1.4rem; margin-bottom: 0.5rem;">Send a Thank You</h2>
                    <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1rem;">Let the giver know how much this means to you.</p>
                    <textarea id="qcReceiverNote" placeholder="Write your thank you note..." style="width: 100%; min-height: 120px; border: 2px solid var(--border-light); border-radius: 12px; padding: 1rem; font-family: inherit; font-size: 1rem; resize: vertical; box-sizing: border-box;"></textarea>
                    <button class="btn btn-primary" onclick="saveReceiverData()" style="width: 100%; margin-top: 1.5rem;">💝 Send Thank You</button>
                </div>
                <div id="qcReceiverSent" style="display: none; text-align: center; padding: 1rem 0;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">💝</div>
                    <h2 style="font-family: 'Crimson Pro', serif;">Thank You Sent!</h2>
                    <p style="color: var(--text-muted);">Your response has been woven into this thread.</p>
                </div>
            </div>
            
            <!-- Business role: form to add info (shows when no business data yet) -->
            <div id="qcBizForm" style="display: none;">
                <h2 style="font-family: 'Crimson Pro', serif; font-size: 1.4rem; margin-bottom: 0.5rem;">Add Your Business Info</h2>
                <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1rem;">Add details about your business or product for this QR code.</p>
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem;">Business Name</label>
                    <input type="text" id="qcBizName" placeholder="Your business name" style="width: 100%; border: 2px solid var(--border-light); border-radius: 12px; padding: 0.75rem 1rem; font-family: inherit; font-size: 1rem; box-sizing: border-box;">
                </div>
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem;">Description</label>
                    <textarea id="qcBizDesc" placeholder="Tell people about your product or service..." style="width: 100%; min-height: 100px; border: 2px solid var(--border-light); border-radius: 12px; padding: 1rem; font-family: inherit; font-size: 1rem; resize: vertical; box-sizing: border-box;"></textarea>
                </div>
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem;">Contact Email (optional)</label>
                    <input type="email" id="qcBizEmail" placeholder="hello@yourbusiness.com" style="width: 100%; border: 2px solid var(--border-light); border-radius: 12px; padding: 0.75rem 1rem; font-family: inherit; font-size: 1rem; box-sizing: border-box;">
                </div>
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem;">Phone (optional)</label>
                    <input type="tel" id="qcBizPhone" placeholder="(555) 123-4567" style="width: 100%; border: 2px solid var(--border-light); border-radius: 12px; padding: 0.75rem 1rem; font-family: inherit; font-size: 1rem; box-sizing: border-box;">
                </div>
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem;">Photo (optional)</label>
                    <input type="file" id="qcBizPhotoInput" accept="image/*" onchange="handleBizPhoto(this)" style="font-size: 0.9rem;">
                    <div id="qcBizPhotoPreview" style="margin-top: 0.75rem;"></div>
                </div>
                <button class="btn btn-primary" onclick="saveBusinessData()" style="width: 100%; margin-top: 1rem;">🏢 Save Business Info</button>
            </div>

            <!-- Business role: locked out message (shows after business data saved) -->
            <div id="qcBizLocked" style="display: none; text-align: center; padding: 2rem 0;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">🔒</div>
                <h2 style="font-family: 'Crimson Pro', serif;">Business Info Added</h2>
                <p style="color: var(--text-muted);">Your business data is saved. You can edit your QR codes on <a href="https://dayduyen.tech" style="color: var(--brand-red);">dayduyen.tech</a></p>
                <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 0.5rem;">Personal messages between givers and receivers are private.</p>
            </div>
            
            <!-- Save to tapestry button (always available) -->
            <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-light); text-align: center;">
                <button class="btn btn-secondary" onclick="saveToTapestry()" style="width: 100%;">🧵 Save to My Tapestry</button>
            </div>
        </div>
    </div>
</div>

<!-- =============================================
     SCREEN 3: AUTH CHOICE
============================================= -->
<div class="screen" id="authScreen">
    <div class="container-narrow">
        <div class="logo-header" onclick="navigate('home')">
            <div class="logo-symbol">緣</div>
            <div class="logo-text">DUYÊN</div>
        </div>
        <div class="card">
            <h1>Welcome to Duyên</h1>
            <p class="subtitle">Sign in to weave your tapestry</p>

            <div style="display: flex; flex-direction: column; gap: 0.75rem; margin-bottom: 1.5rem;">
                <button class="btn-social" onclick="handleGoogleAuth()">
                    <span style="font-size: 1.3rem;">🔵</span> Continue with Google
                </button>
                <button class="btn-social" onclick="handleAppleAuth()">
                    <span style="font-size: 1.3rem;">🍎</span> Continue with Apple
                </button>
            </div>

            <div class="divider"><span>or</span></div>

            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                <button class="btn btn-primary btn-full" onclick="navigate('login')">Sign In with Email</button>
                <button class="btn btn-secondary btn-full" onclick="navigate('signup')">Create New Account</button>
            </div>

            <div class="text-link">
                <a href="#" onclick="skipAuth(); return false;">Continue as Guest</a>
            </div>
        </div>
    </div>
</div>

<!-- =============================================
     SCREEN 4: LOGIN
============================================= -->
<div class="screen" id="loginScreen">
    <div class="container-narrow">
        <div class="logo-header" onclick="navigate('home')">
            <div class="logo-symbol">緣</div>
            <div class="logo-text">DUYÊN</div>
        </div>
        <div class="card">
            <h1>Welcome Back</h1>
            <p class="subtitle">Sign in to your Duyên account</p>

            <div class="form-group">
                <label>Email Address</label>
                <input type="email" id="loginEmail" placeholder="your@email.com">
            </div>

            <div class="form-group">
                <label>Password</label>
                <div class="password-toggle">
                    <input type="password" id="loginPassword" placeholder="Enter your password">
                    <button type="button" class="password-toggle-btn" onclick="togglePassword('loginPassword')">👁️</button>
                </div>
            </div>

            <div class="text-link" style="text-align: right; margin-top: -0.5rem; margin-bottom: 1.25rem;">
                <a href="#" onclick="navigate('forgot'); return false;">Forgot Password?</a>
            </div>

            <button class="btn btn-primary btn-full" onclick="handleLogin()">Sign In</button>

            <div class="text-link">Don't have an account? <a href="#" onclick="navigate('signup'); return false;">Sign Up</a></div>
            <div class="text-link"><a href="#" onclick="navigate('auth'); return false;">← Back</a></div>
        </div>
    </div>
</div>

<!-- =============================================
     SCREEN 5: SIGNUP
============================================= -->
<div class="screen" id="signupScreen">
    <div class="container-narrow">
        <div class="logo-header" onclick="navigate('home')">
            <div class="logo-symbol">緣</div>
            <div class="logo-text">DUYÊN</div>
        </div>
        <div class="card">
            <h1>Create Account</h1>
            <p class="subtitle">Join Duyên to save your connections</p>

            <div class="form-group">
                <label>Full Name <span class="required">*</span></label>
                <input type="text" id="signupName" placeholder="Enter your name">
            </div>

            <div class="form-group">
                <label>Email Address <span class="required">*</span></label>
                <input type="email" id="signupEmail" placeholder="your@email.com">
            </div>

            <div class="form-group">
                <label>Password <span class="required">*</span></label>
                <div class="password-toggle">
                    <input type="password" id="signupPassword" placeholder="Create a strong password">
                    <button type="button" class="password-toggle-btn" onclick="togglePassword('signupPassword')">👁️</button>
                </div>
                <div class="hint">At least 8 characters with letters and numbers</div>
            </div>

            <div class="form-group">
                <label>Confirm Password <span class="required">*</span></label>
                <div class="password-toggle">
                    <input type="password" id="signupConfirm" placeholder="Confirm your password">
                    <button type="button" class="password-toggle-btn" onclick="togglePassword('signupConfirm')">👁️</button>
                </div>
            </div>

            <button class="btn btn-primary btn-full" onclick="handleSignup()">Create Account</button>

            <div class="text-link">Already have an account? <a href="#" onclick="navigate('login'); return false;">Sign In</a></div>
            <div class="text-link"><a href="#" onclick="navigate('auth'); return false;">← Back</a></div>
        </div>
    </div>
</div>

<!-- =============================================
     SCREEN 6: EMAIL VERIFICATION
============================================= -->
<div class="screen" id="verifyScreen">
    <div class="container-narrow">
        <div class="logo-header" onclick="navigate('home')">
            <div class="logo-symbol">緣</div>
            <div class="logo-text">DUYÊN</div>
        </div>
        <div class="card" style="text-align: center; position: relative;">

            <!-- Success overlay (hidden by default, shown after verification) -->
            <div id="verifySuccessOverlay" style="display: none;" class="verify-success-overlay">
                <div class="checkmark-circle">
                    <svg viewBox="0 0 40 40">
                        <path d="M10 20 L17 27 L30 13"/>
                    </svg>
                </div>
                <h2 style="font-family: 'Crimson Pro', serif; margin-bottom: 0.5rem;">Email Verified!</h2>
                <p style="color: var(--text-secondary); font-size: 0.95rem;" id="verifySuccessName">Welcome to Duyên</p>
            </div>

            <!-- Email sent animation -->
            <div class="email-sent-animation">
                <div class="email-icon-animated">📧</div>
            </div>

            <h1>Check Your Email</h1>
            <p class="subtitle" style="margin-bottom: 0.5rem;">We sent a 6-digit verification code to</p>
            <p style="font-weight: 700; color: var(--text-primary); font-size: 1.05rem; margin-bottom: 0.25rem;" id="verifyEmailDisplay"></p>

            <!-- Demo hint (remove in production) -->
            <div class="demo-code-hint">
                <span>🧪</span>
                <span>Demo mode — use code <code id="demoCodeDisplay">123456</code></span>
            </div>

            <!-- Code inputs -->
            <div class="code-inputs" id="codeInputs">
                <input type="text" inputmode="numeric" class="code-input" maxlength="1" id="code1" autocomplete="one-time-code">
                <input type="text" inputmode="numeric" class="code-input" maxlength="1" id="code2">
                <input type="text" inputmode="numeric" class="code-input" maxlength="1" id="code3">
                <input type="text" inputmode="numeric" class="code-input" maxlength="1" id="code4">
                <input type="text" inputmode="numeric" class="code-input" maxlength="1" id="code5">
                <input type="text" inputmode="numeric" class="code-input" maxlength="1" id="code6">
            </div>

            <!-- Status message -->
            <div class="verify-status" id="verifyStatus"></div>

            <!-- Verify button -->
            <button class="btn btn-primary btn-full" id="verifyBtn" onclick="handleVerification()">
                Verify Email
            </button>

            <!-- Resend timer -->
            <div class="resend-timer" id="resendArea">
                Didn't receive the code?
                <button class="resend-btn" id="resendBtn" onclick="resendCode()" disabled>
                    Resend in <span id="resendTimer">30</span>s
                </button>
            </div>

            <div class="text-link" style="margin-top: 1.25rem;">
                <a href="#" onclick="navigate('signup'); return false;">← Change Email</a>
            </div>
        </div>
    </div>
</div>

<!-- =============================================
     SCREEN 7: FORGOT PASSWORD
============================================= -->
<div class="screen" id="forgotScreen">
    <div class="container-narrow">
        <div class="logo-header" onclick="navigate('home')">
            <div class="logo-symbol">緣</div>
            <div class="logo-text">DUYÊN</div>
        </div>
        <div class="card">
            <div style="text-align: center; font-size: 3rem; margin-bottom: 1rem;">🔑</div>
            <h1>Reset Password</h1>
            <p class="subtitle">Enter your email to receive a reset link</p>

            <div class="form-group">
                <label>Email Address</label>
                <input type="email" id="resetEmail" placeholder="your@email.com">
            </div>

            <button class="btn btn-primary btn-full" onclick="handleForgotPassword()">Send Reset Link</button>
            <div class="text-link"><a href="#" onclick="navigate('login'); return false;">← Back to Sign In</a></div>
        </div>
    </div>
</div>

<!-- =============================================
     SCREEN 8: BUSINESS FORM
============================================= -->
<div class="screen" id="businessScreen">
    <div class="container">
        <div class="logo-header" onclick="navigate('home')">
            <div class="logo-symbol">緣</div>
            <div class="logo-text">DUYÊN</div>
        </div>
        <div class="card">
            <h1>Share Your Story</h1>
            <p class="subtitle">Help people connect with your business</p>

            <div class="form-group">
                <label>Business Name <span class="required">*</span></label>
                <input type="text" id="bizName" required>
            </div>
            <div class="form-group">
                <label>Product or Service Name</label>
                <input type="text" id="prodName">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="bizDesc"></textarea>
                <div class="hint">Share what makes you special</div>
            </div>
            <div class="form-group">
                <label>Contact Email</label>
                <input type="email" id="bizEmail">
            </div>
            <div class="form-group">
                <label>Phone Number</label>
                <input type="tel" id="bizPhone">
            </div>
            <div class="form-group">
                <label>Business Links</label>
                <div class="hint" style="margin-bottom: 0.75rem;">Add your website, social media, etc.</div>
                <div id="linksContainer">
                    <div class="link-row">
                        <input type="url" placeholder="https://your-website.com" data-link>
                        <button type="button" class="btn-icon" onclick="addLink()">+</button>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label>Photos & Videos</label>
                <div class="upload-area" onclick="document.getElementById('bizMedia').click()">
                    <input type="file" id="bizMedia" multiple accept="image/*,video/*" style="display:none" onchange="handleMedia(this,'biz')">
                    <div class="upload-icon">📸</div>
                    <div>Upload Photos or Videos</div>
                    <div class="hint">Click to browse</div>
                </div>
                <div class="previews" id="bizPreviews"></div>
            </div>
            <div class="form-group">
                <label>Additional Files</label>
                <div class="hint" style="margin-bottom: 0.75rem;">Care instructions, warranty, certificates</div>
                <div class="upload-area" onclick="document.getElementById('bizFiles').click()">
                    <input type="file" id="bizFiles" multiple accept=".pdf,.doc,.docx" style="display:none" onchange="handleFiles(this)">
                    <div class="upload-icon">📄</div>
                    <div>Upload Documents</div>
                </div>
                <div id="filesList"></div>
            </div>

            <div class="btn-group">
                <button class="btn btn-secondary" onclick="navigate('qr')">← Back</button>
                <button class="btn btn-primary" onclick="saveBusiness()">Save & Preview →</button>
            </div>
        </div>
    </div>
</div>

<!-- =============================================
     SCREEN 8b: BUSINESS PROFILE (create/edit)
============================================= -->
<div class="screen" id="bizProfileScreen">
    <div class="container">
        <div class="logo-header" onclick="navigate('home')">
            <div class="logo-symbol">緣</div>
            <div class="logo-text">DUYÊN</div>
        </div>
        <div class="card">
            <h1 id="profileScreenTitle">Set Up Your Business Profile</h1>
            <p class="subtitle" id="profileScreenSub">Save once, use on every QR code</p>

            <div class="form-group">
                <label>Business Name <span class="required">*</span></label>
                <input type="text" id="profileBizName" placeholder="e.g. Saigon Blossoms">
            </div>
            <div class="form-group">
                <label>Contact Email</label>
                <input type="email" id="profileEmail" placeholder="hello@yourbusiness.com">
            </div>
            <div class="form-group">
                <label>Phone Number</label>
                <input type="tel" id="profilePhone" placeholder="(555) 123-4567">
            </div>
            <div class="form-group">
                <label>Business Links</label>
                <div class="hint" style="margin-bottom: 0.75rem;">Website, Instagram, Facebook, etc.</div>
                <div id="profileLinksContainer">
                    <div class="link-row">
                        <input type="url" placeholder="https://your-website.com" data-profile-link>
                        <button type="button" class="btn-icon" onclick="addProfileLink()">+</button>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label>Logo & Brand Photos</label>
                <div class="hint" style="margin-bottom: 0.75rem;">These will appear on every QR code you claim</div>
                <div class="upload-area" onclick="document.getElementById('profileMedia').click()">
                    <input type="file" id="profileMedia" multiple accept="image/*" style="display:none" onchange="handleMedia(this,'profile')">
                    <div class="upload-icon">🏢</div>
                    <div>Upload Logo & Photos</div>
                </div>
                <div class="previews" id="profilePreviews"></div>
            </div>

            <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 2px solid var(--border-light);">
                <h2 style="margin-bottom: 0.5rem;">Product Templates</h2>
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1.5rem;">Create reusable templates for products you sell often. When you claim a QR code, just pick a template.</p>

                <div class="template-grid" id="profileTemplateGrid"></div>
            </div>

            <div class="btn-group">
                <button class="btn btn-secondary" id="profileBackBtn" onclick="navigate('auth')">← Back</button>
                <button class="btn btn-primary" onclick="saveBusinessProfile()">Save Profile →</button>
            </div>
        </div>
    </div>
</div>

<!-- =============================================
     SCREEN 8c: PRODUCT TEMPLATE EDITOR
============================================= -->
<div class="screen" id="templateEditScreen">
    <div class="container">
        <div class="logo-header" onclick="navigate('home')">
            <div class="logo-symbol">緣</div>
            <div class="logo-text">DUYÊN</div>
        </div>
        <div class="card">
            <h1 id="templateEditTitle">New Product Template</h1>
            <p class="subtitle">Create a reusable template for this product</p>

            <div class="form-group">
                <label>Product Name <span class="required">*</span></label>
                <input type="text" id="tplProdName" placeholder="e.g. Spring Bouquet Collection">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="tplDesc" placeholder="Describe this product or service..."></textarea>
                <div class="hint">This can be edited when you claim a QR code</div>
            </div>
            <div class="form-group">
                <label>Default Video Message</label>
                <div class="hint" style="margin-bottom: 0.75rem;">Upload a video that plays when someone scans this product's QR code</div>
                <div class="upload-area" onclick="document.getElementById('tplMedia').click()">
                    <input type="file" id="tplMedia" multiple accept="image/*,video/*" style="display:none" onchange="handleMedia(this,'tpl')">
                    <div class="upload-icon">🎬</div>
                    <div>Upload Photos & Videos</div>
                </div>
                <div class="previews" id="tplPreviews"></div>
            </div>
            <div class="form-group">
                <label>Documents</label>
                <div class="hint" style="margin-bottom: 0.75rem;">Care instructions, warranty, certificates</div>
                <div class="upload-area" onclick="document.getElementById('tplFiles').click()">
                    <input type="file" id="tplFiles" multiple accept=".pdf,.doc,.docx" style="display:none" onchange="handleFiles(this)">
                    <div class="upload-icon">📄</div>
                    <div>Upload Documents</div>
                </div>
                <div id="tplFilesList"></div>
            </div>
            <div class="form-group">
                <label>Template Icon</label>
                <div class="hint" style="margin-bottom: 0.5rem;">Pick an emoji to identify this template quickly</div>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;" id="iconPicker">
                    <button type="button" class="btn-icon" onclick="pickIcon('💐')" style="font-size: 1.5rem;">💐</button>
                    <button type="button" class="btn-icon" onclick="pickIcon('👗')" style="font-size: 1.5rem;">👗</button>
                    <button type="button" class="btn-icon" onclick="pickIcon('☕')" style="font-size: 1.5rem;">☕</button>
                    <button type="button" class="btn-icon" onclick="pickIcon('🎂')" style="font-size: 1.5rem;">🎂</button>
                    <button type="button" class="btn-icon" onclick="pickIcon('📦')" style="font-size: 1.5rem;">📦</button>
                    <button type="button" class="btn-icon" onclick="pickIcon('🧵')" style="font-size: 1.5rem;">🧵</button>
                    <button type="button" class="btn-icon" onclick="pickIcon('🎁')" style="font-size: 1.5rem;">🎁</button>
                    <button type="button" class="btn-icon" onclick="pickIcon('💎')" style="font-size: 1.5rem;">💎</button>
                    <button type="button" class="btn-icon" onclick="pickIcon('🧴')" style="font-size: 1.5rem;">🧴</button>
                    <button type="button" class="btn-icon" onclick="pickIcon('🍰')" style="font-size: 1.5rem;">🍰</button>
                </div>
                <div style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--text-secondary);">
                    Selected: <span id="selectedIcon" style="font-size: 1.5rem;">💐</span>
                </div>
            </div>

            <div class="btn-group">
                <button class="btn btn-secondary" onclick="navigate('bizProfile')">← Back</button>
                <button class="btn btn-primary" onclick="saveTemplate()">Save Template →</button>
            </div>
        </div>
    </div>
</div>

<!-- =============================================
     SCREEN 8d: CLAIM QR CODE (quick flow)
============================================= -->
<div class="screen" id="bizClaimScreen">
    <div class="container">
        <div class="logo-header" onclick="navigate('home')">
            <div class="logo-symbol">緣</div>
            <div class="logo-text">DUYÊN</div>
        </div>
        <div class="card">
            <h1>Claim This QR Code</h1>
            <p class="subtitle">Link this code to your business in seconds</p>

            <!-- Profile summary -->
            <div class="profile-summary" id="claimProfileSummary">
                <div class="profile-avatar">🏢</div>
                <div class="profile-info">
                    <div class="profile-name" id="claimBizName">Your Business</div>
                    <div class="profile-detail">📧 <span id="claimBizEmail">email</span></div>
                    <div class="profile-detail">📱 <span id="claimBizPhone">phone</span></div>
                    <div class="profile-links" id="claimBizLinks"></div>
                </div>
                <button class="profile-edit-btn" onclick="navigate('bizProfile')">Edit</button>
            </div>

            <!-- Template picker -->
            <div style="margin-bottom: 1.5rem;">
                <label style="margin-bottom: 0.75rem; display: block;">Choose a Product Template</label>
                <div class="template-grid" id="claimTemplateGrid"></div>
            </div>

            <!-- Customize area (shown after picking template) -->
            <div id="claimCustomize" style="display: none;">
                <div style="padding-top: 1rem; border-top: 2px solid var(--border-light);">
                    <label style="margin-bottom: 0.25rem; display: block;">Customize for This Code</label>
                    <div class="hint" style="margin-bottom: 1rem;">Edit anything specific to this QR code. Your template stays unchanged.</div>

                    <div class="form-group">
                        <label>Product Name</label>
                        <input type="text" id="claimProdName">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="claimDesc"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Additional Photos & Videos</label>
                        <div class="upload-area" onclick="document.getElementById('claimMedia').click()">
                            <input type="file" id="claimMedia" multiple accept="image/*,video/*" style="display:none" onchange="handleMedia(this,'claim')">
                            <div class="upload-icon">📸</div>
                            <div>Add product-specific media</div>
                        </div>
                        <div class="previews" id="claimPreviews"></div>
                    </div>
                </div>
            </div>

            <!-- Claim summary -->
            <div class="claim-preview" id="claimSummary" style="display: none;">
                <div class="claim-preview-label">What will be published</div>
                <div class="claim-row">
                    <span class="claim-row-label">Business</span>
                    <span class="claim-row-value" id="claimSumBiz">—</span>
                </div>
                <div class="claim-row">
                    <span class="claim-row-label">Product</span>
                    <span class="claim-row-value" id="claimSumProd">—</span>
                </div>
                <div class="claim-row">
                    <span class="claim-row-label">Contact</span>
                    <span class="claim-row-value" id="claimSumContact">—</span>
                </div>
            </div>

            <div class="btn-group">
                <button class="btn btn-secondary" onclick="navigate('qr')">← Back</button>
                <button class="btn btn-primary" id="claimBtn" onclick="claimQRCode()" disabled style="opacity: 0.5;">
                    Select a template first
                </button>
            </div>
        </div>
    </div>
</div>

<!-- =============================================
     SCREEN 9: GIVER FORM
============================================= -->
<div class="screen" id="giverScreen">
    <div class="container">
        <div class="logo-header" onclick="navigate('home')">
            <div class="logo-symbol">緣</div>
            <div class="logo-text">DUYÊN</div>
        </div>
        <div class="card">
            <h1>Make It Personal</h1>
            <p class="subtitle">Add your message to make this gift unforgettable</p>

            <div class="form-group">
                <label>Your Name <span class="required">*</span></label>
                <input type="text" id="giverName" required>
            </div>
            <div class="form-group">
                <label>Recipient's Name</label>
                <input type="text" id="recipName">
            </div>
            <div class="form-group">
                <label>Your Message <span class="required">*</span></label>
                <textarea id="giverMsg" required></textarea>
                <div class="hint">This will be preserved forever in their tapestry</div>
            </div>
            <div class="form-group">
                <label>Occasion</label>
                <input type="text" id="occasion" placeholder="Birthday, Anniversary, Just Because...">
            </div>
            <div class="form-group">
                <label>Add Photos or Videos</label>
                <div class="upload-area" onclick="document.getElementById('giverMedia').click()">
                    <input type="file" id="giverMedia" multiple accept="image/*,video/*" style="display:none" onchange="handleMedia(this,'giver')">
                    <div class="upload-icon">📸</div>
                    <div>Upload Photos or Videos</div>
                </div>
                <div class="previews" id="giverPreviews"></div>
            </div>

            <div class="btn-group">
                <button class="btn btn-secondary" onclick="navigate('threadView')">← Back</button>
                <button class="btn btn-primary" onclick="saveGiver()">Add My Message →</button>
            </div>
        </div>
    </div>
</div>

<!-- =============================================
     SCREEN 10: THREAD VIEW (content display)
============================================= -->
<div class="screen" id="threadViewScreen">
    <div class="container">
        <div class="logo-header" onclick="navigate('home')">
            <div class="logo-symbol">緣</div>
            <div class="logo-text">DUYÊN</div>
        </div>
        <div class="card">
            <!-- Business Owner Banner (hidden by default) -->
            <div id="bizOwnerBanner" style="display: none;">
                <div class="biz-owner-banner">
                    <div class="biz-owner-banner-icon">🏢</div>
                    <div class="biz-owner-banner-text">
                        <div class="biz-owner-banner-label">Business Owner View</div>
                        <div class="biz-owner-banner-sub">Personal content is private between givers and receivers</div>
                    </div>
                </div>
            </div>

            <div class="business-header">
                <div class="business-name" id="displayBizName">Happy Flowers</div>
                <div class="product-name" id="displayProdName">Spring Bouquet Collection</div>
                <p class="description" id="displayDesc">Hand-selected seasonal blooms arranged fresh this morning with care and love.</p>
            </div>

            <!-- Analytics Bar (business owners only, hidden by default) -->
            <div id="analyticsBar" style="display: none;">
                <div class="section-title">Your QR Code Activity</div>
                <div class="analytics-bar">
                    <div class="analytics-stat">
                        <div class="analytics-stat-number" id="analyticScans">0</div>
                        <div class="analytics-stat-label">Total Scans</div>
                    </div>
                    <div class="analytics-stat">
                        <div class="analytics-stat-number" id="analyticGivers">0</div>
                        <div class="analytics-stat-label">Gift Messages</div>
                    </div>
                    <div class="analytics-stat">
                        <div class="analytics-stat-number" id="analyticResponses">0</div>
                        <div class="analytics-stat-label">Responses</div>
                    </div>
                    <div class="analytics-stat">
                        <div class="analytics-stat-number" id="analyticSaved">0</div>
                        <div class="analytics-stat-label">Saved to Tapestry</div>
                    </div>
                </div>
            </div>

            <div class="section-title">Contact Information</div>
            <div class="contact-grid">
                <div class="contact-item">
                    <div class="contact-icon">📧</div>
                    <div>
                        <div class="contact-label">Email</div>
                        <div class="contact-value" id="displayEmail"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="3d55585151527d555c4d4d445b51524a584f4e135e5250">[email&#160;protected]</a></div>
                    </div>
                </div>
                <div class="contact-item">
                    <div class="contact-icon">📱</div>
                    <div>
                        <div class="contact-label">Phone</div>
                        <div class="contact-value" id="displayPhone">(555) 123-4567</div>
                    </div>
                </div>
            </div>

            <div id="linksDisplay"></div>
            <div id="mediaDisplay"></div>
            <div id="filesDisplay"></div>

            <!-- PRIVACY SHIELD (shown to business owners) -->
            <div id="privacyShield" style="display: none;">
                <div class="privacy-shield">
                    <div class="shield-icon">🔒</div>
                    <h3>Personal Content Protected</h3>
                    <p>Gift messages and receiver responses are private conversations between givers and receivers. This keeps their experience personal and meaningful.</p>
                    <div class="privacy-badge">
                        <span class="privacy-badge-dot"></span>
                        Privacy by design
                    </div>
                </div>

                <!-- Blurred preview of giver message -->
                <div id="blurredGiver" style="display: none;">
                    <div class="section-title">Gift Message</div>
                    <div class="blurred-preview">
                        <div class="blurred-content">
                            <div class="fake-line"></div>
                            <div class="fake-line"></div>
                            <div class="fake-line"></div>
                            <div class="fake-line"></div>
                        </div>
                        <div class="blurred-overlay">
                            <div class="blurred-lock">🔒 Private</div>
                        </div>
                    </div>
                </div>

                <!-- Blurred preview of receiver response -->
                <div id="blurredResponse" style="display: none;">
                    <div class="section-title">Receiver's Response</div>
                    <div class="blurred-preview">
                        <div class="blurred-content">
                            <div class="fake-line"></div>
                            <div class="fake-line"></div>
                            <div class="fake-line"></div>
                        </div>
                        <div class="blurred-overlay">
                            <div class="blurred-lock">🔒 Private</div>
                        </div>
                    </div>
                </div>

                <!-- Edit business info button -->
                <div class="action-section" style="margin-top: 2rem;">
                    <div class="action-title">Manage Your Listing</div>
                    <div class="action-subtitle">Update your business details anytime</div>
                    <button class="btn btn-primary" onclick="navigate('business')">✏️ Edit Business Info</button>
                </div>
            </div>

            <!-- PERSONAL CONTENT (hidden from business owners) -->
            <div id="personalContent">
                <div id="giverMessageDisplay"></div>

                <!-- Respond prompt -->
                <div id="respondSection" style="display: none;">
                    <div class="action-section" style="background: #fff8f0; border-color: var(--golden-thread);">
                        <div class="action-title">💬 This Gift Has a Message for You</div>
                        <div class="action-subtitle">Read it above, then let the giver know you received it</div>
                        <button class="btn btn-primary" onclick="handleAction('respond')">Send Your Response</button>
                    </div>
                </div>

                <div id="receiverResponseDisplay"></div>

                <!-- Save to collection -->
                <div id="saveToCollection" style="display: none;">
                    <div class="action-section" style="background: #f0faf4; border-color: var(--sage);">
                        <div class="action-title">💝 Save This Memory</div>
                        <div class="action-subtitle">Add this thread to your personal tapestry</div>
                        <button class="btn btn-primary" onclick="saveToCollection()">Save to My Tapestry</button>
                    </div>
                </div>

                <!-- Action buttons -->
                <div class="action-section" id="actionButtons">
                    <div class="action-title">What would you like to do?</div>
                    <div class="action-subtitle">Continue building this connection</div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="handleAction('giver')">🎁 I'm Giving This Gift</button>
                        <button class="btn btn-secondary" onclick="handleAction('receiver')">💝 I Received This</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- =============================================
     SCREEN 11: RECEIVER VIEW
============================================= -->
<div class="screen" id="receiverScreen">
    <div class="container">
        <div class="logo-header" onclick="navigate('home')">
            <div class="logo-symbol">緣</div>
            <div class="logo-text">DUYÊN</div>
        </div>
        <div class="card">
            <h1>A Gift for You</h1>
            <p class="subtitle">Someone chose this with care</p>

            <div style="background: var(--soft-sand); padding: 1.5rem; border-radius: 16px; margin-bottom: 1.5rem;">
                <div style="font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem; font-weight: 600;">From</div>
                <h3 id="recvBizName" style="font-family: 'Crimson Pro', serif; font-size: 1.35rem;">Happy Flowers</h3>
                <p id="recvProdName" style="color: var(--text-secondary); font-size: 0.95rem;">Spring Bouquet — Fresh seasonal flowers</p>
            </div>

            <div id="receiverMessageView"></div>

            <div class="alert alert-info">
                <strong>💡 Tip:</strong> Respond to the gift giver to complete the connection!
            </div>

            <div class="btn-group">
                <button class="btn btn-secondary" onclick="navigate('threadView')">← Back to Details</button>
                <button class="btn btn-primary" onclick="navigate('response')">💬 Send Response</button>
            </div>
        </div>
    </div>
</div>

<!-- =============================================
     SCREEN 12: RESPONSE FORM
============================================= -->
<div class="screen" id="responseScreen">
    <div class="container">
        <div class="logo-header" onclick="navigate('home')">
            <div class="logo-symbol">緣</div>
            <div class="logo-text">DUYÊN</div>
        </div>
        <div class="card">
            <h1>Send Your Thanks</h1>
            <p class="subtitle">Let them know how much this means to you</p>

            <div class="form-group">
                <label>Your Response <span class="required">*</span></label>
                <textarea id="responseMsg" required style="min-height: 150px;"></textarea>
            </div>
            <div class="form-group">
                <label>Add Photos or Videos</label>
                <div class="upload-area" onclick="document.getElementById('respMedia').click()">
                    <input type="file" id="respMedia" multiple accept="image/*,video/*" style="display:none" onchange="handleMedia(this,'resp')">
                    <div class="upload-icon">📸</div>
                    <div>Share how you're enjoying the gift</div>
                </div>
                <div class="previews" id="respPreviews"></div>
            </div>

            <div class="btn-group">
                <button class="btn btn-secondary" onclick="navigate('receiver')">← Back</button>
                <button class="btn btn-primary" onclick="saveResponse()">Send Response →</button>
            </div>
        </div>
    </div>
</div>

<!-- =============================================
     SCREEN 13: SUCCESS
============================================= -->
<div class="screen" id="successScreen">
    <div class="container-narrow">
        <div class="logo-header" onclick="navigate('home')">
            <div class="logo-symbol">緣</div>
            <div class="logo-text">DUYÊN</div>
        </div>
        <div class="card" style="text-align: center;">
            <div class="success-icon">✨</div>
            <h1>Thread Woven</h1>
            <p class="subtitle" id="successMsg">Your connection has been saved!</p>

            <div class="btn-group">
                <button class="btn btn-secondary" onclick="navigate('threadView')">View Thread</button>
                <button class="btn btn-primary" onclick="navigate('tapestry')">View My Tapestry →</button>
            </div>
        </div>
    </div>
</div>

<!-- =============================================
     SCREEN 14: TAPESTRY (My Collection)
============================================= -->
<div class="screen" id="tapestryScreen">
    <!-- Sticky header -->
    <header class="app-header">
        <div class="header-inner">
            <a class="header-logo" onclick="navigate('home')">
                <div class="logo-symbol">緣</div>
            <div class="logo-text">DUYÊN</div>
            </a>
            <div class="header-actions">
                <input type="text" class="header-search" placeholder="Search threads..." id="tapestrySearch" oninput="renderTapestry()">
                <button class="header-btn header-btn-ghost" onclick="navigate('home')">About</button>
                <button class="header-btn header-btn-primary" onclick="openScanner()">📸 Scan</button>
                <button class="header-btn header-btn-ghost" onclick="logoutDuyen()" style="color: var(--text-muted);">Log Out</button>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Welcome stats -->
        <div class="tapestry-welcome">
            <h1 id="tapestryTitle">Your Tapestry</h1>
            <p class="subtitle" style="margin-bottom: 0;">Your woven collection of meaningful threads</p>
            <div class="stats-row">
                <div class="stat">
                    <div class="stat-number" id="statTotal">0</div>
                    <div class="stat-label">Threads</div>
                </div>
                <div class="stat">
                    <div class="stat-number" id="statMonth">0</div>
                    <div class="stat-label">This Month</div>
                </div>
                <div class="stat">
                    <div class="stat-number" id="statCategories">0</div>
                    <div class="stat-label">Categories</div>
                </div>
            </div>
        </div>

        <!-- Filter tabs -->
        <div class="filter-tabs" id="tapestryFilters">
            <div class="filter-tab active" onclick="filterTapestry('all', this)">All</div>
            <div class="filter-tab" onclick="filterTapestry('thing', this)">🎁 Things</div>
            <div class="filter-tab" onclick="filterTapestry('person', this)">👥 People</div>
            <div class="filter-tab" onclick="filterTapestry('place', this)">📍 Places</div>
        </div>

        <!-- Thread cards -->
        <div class="threads-grid" id="tapestryGrid"></div>

        <!-- Empty state -->
        <div class="tapestry-empty" id="tapestryEmpty" style="display: none;">
            <h2>Your Tapestry Awaits</h2>
            <p>Begin weaving by scanning your first Duyên QR code. Each scan creates a thread in your collection.</p>
            <button class="btn btn-primary" onclick="openScanner()">📸 Scan Your First QR Code</button>
        </div>

        <!-- Timeline -->
        <div class="timeline-section" id="timelineSection" style="display: none;">
            <h2>Days of My Life</h2>
            <p class="timeline-subtitle">Your threads woven through time</p>
            <div class="timeline-scroll" id="timelineScroll"></div>
        </div>
    </div>

    <!-- FAB -->
    <button class="fab" onclick="openScanner()" title="Scan QR Code">📸</button>
</div>

<!-- =============================================
     QR SCANNER OVERLAY
============================================= -->
<div class="scanner-overlay" id="scannerOverlay">
    <div class="scanner-header">
        <h3>Scan QR Code</h3>
        <button class="scanner-close" onclick="closeScanner()">✕</button>
    </div>
    <div class="scanner-viewfinder">
        <div id="qr-reader"></div>
    </div>
    <div class="scanner-hint">
        Point your camera at any QR code
        <div class="scanner-manual">
            <input type="text" id="manualQRInput" placeholder="Or paste a URL...">
            <button onclick="handleManualURL()">Go</button>
        </div>
    </div>
</div>

<!-- =============================================
     EXTERNAL QR NOTE SCREEN
============================================= -->
<div class="screen" id="externalQrScreen">
    <!-- Sticky header -->
    <header class="app-header">
        <div class="header-inner">
            <a class="header-logo" onclick="navigate('tapestry')">
                <div class="logo-symbol">緣</div>
            <div class="logo-text">DUYÊN</div>
            </a>
            <div class="header-actions">
                <button class="header-btn header-btn-ghost" onclick="navigate('tapestry')">← Back</button>
            </div>
        </div>
    </header>

    <div class="container">
        <div style="text-align: center; margin-bottom: 1.5rem;">
            <div style="font-size: 3rem; margin-bottom: 0.5rem;">📌</div>
            <h2 style="font-family: 'Crimson Pro', serif; font-size: 1.75rem; color: var(--text-primary); margin-bottom: 0.25rem;">Save to Your Tapestry</h2>
            <p class="subtitle">Add this moment to the days of your life</p>
        </div>

        <!-- Scanned URL display -->
        <div class="external-qr-url">
            <span class="url-icon">🔗</span>
            <span id="externalUrl"></span>
        </div>

        <!-- Title -->
        <div class="form-group">
            <label>What is this? <span class="required">*</span></label>
            <input type="text" id="extTitle" placeholder="e.g., Dinner at Saigon Rose, Museum exhibit, Concert ticket" oninput="document.getElementById('extTitleError').style.display='none'; this.style.borderColor='';">
            <div id="extTitleError" style="display: none; color: var(--brand-red); font-size: 0.8rem; margin-top: 4px; font-weight: 500;">Please give this thread a title</div>
        </div>

        <!-- Category picker -->
        <div class="form-group">
            <label>Category</label>
            <div class="category-picker">
                <div class="category-option selected" onclick="selectCategory('thing', this)">
                    <span class="cat-icon">🎁</span>
                    <span class="cat-label">Thing</span>
                </div>
                <div class="category-option" onclick="selectCategory('person', this)">
                    <span class="cat-icon">👤</span>
                    <span class="cat-label">Person</span>
                </div>
                <div class="category-option" onclick="selectCategory('place', this)">
                    <span class="cat-icon">📍</span>
                    <span class="cat-label">Place</span>
                </div>
            </div>
        </div>

        <!-- Notes -->
        <div class="form-group">
            <label>Notes</label>
            <textarea id="extNotes" placeholder="What was special about this moment? How did it make you feel?" rows="4"></textarea>
        </div>

        <!-- Photo upload -->
        <div class="form-group">
            <label>Photos</label>
            <div style="display: flex; align-items: center; gap: 10px;">
                <button class="btn btn-secondary" onclick="document.getElementById('extPhotoInput').click()" style="font-size: 0.9rem; padding: 10px 18px;">
                    📷 Add Photos
                </button>
                <span style="font-size: 0.8rem; color: var(--text-muted);" id="extPhotoCount"></span>
            </div>
            <input type="file" id="extPhotoInput" accept="image/*" multiple style="display: none;" onchange="handleExtPhotos(this)">
            <div class="photo-preview-grid" id="extPhotoPreview"></div>
        </div>

        <!-- Who is this from / associated with -->
        <div class="form-group">
            <label>Connected to (person, business, or event)</label>
            <input type="text" id="extFrom" placeholder="e.g., Mom, Saigon Rose, Art Walk 2026">
        </div>

        <!-- Tags -->
        <div class="form-group">
            <label>Tags (comma-separated)</label>
            <input type="text" id="extTags" placeholder="e.g., dinner, family, celebration">
        </div>

        <!-- Save buttons -->
        <div style="display: flex; flex-direction: column; gap: 12px; margin-top: 2rem; margin-bottom: 3rem;">
            <button class="btn btn-primary" onclick="saveExternalScan()" style="width: 100%;">🧵 Weave into My Tapestry</button>
            <button class="btn btn-secondary" onclick="navigate('tapestry')" style="width: 100%;">Cancel</button>
        </div>
    </div>
</div>

<!-- =============================================
     THREAD DETAIL SCREEN
============================================= -->
<div class="screen" id="threadDetailScreen">
    <header class="app-header">
        <div class="header-inner">
            <a class="header-logo" onclick="navigate('tapestry')">
                <div class="logo-symbol">緣</div>
            <div class="logo-text">DUYÊN</div>
            </a>
            <div class="header-actions">
                <button class="header-btn header-btn-ghost" onclick="navigate('tapestry')">← Tapestry</button>
            </div>
        </div>
    </header>

    <div class="container">
        <div id="threadDetailContent"></div>
    </div>
</div>


<!-- =============================================
     JAVASCRIPT
============================================= -->
<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
    console.log('🧵 Duyên Unified App Loading...');

    // ==========================================
    // STATE
    // ==========================================
    let currentRole = null;       // 'business', 'giver', 'receiver'
    let isAuthenticated = false;
    let currentUser = null;
    let currentFilter = 'all';
    let previousScreen = null;

    // Thread data (for the QR scan flow)
    let businessData = {};
    let giverData = {};
    let responseData = {};
    let mediaFiles = { biz: [], giver: [], resp: [], profile: [], tpl: [], claim: [] };
    let docFiles = [];
    let tplDocFiles = [];

    // Business Profile (persists across QR codes)
    let businessProfile = null;  // { name, email, phone, links[], media[], templates[] }
    let editingTemplateIndex = -1; // -1 = new, 0+ = editing existing
    let selectedTemplateIndex = -1;
    let selectedIcon = '💐';

    // QR Code ownership & analytics (per code)
    let qrCodeOwner = null;          // email/id of the business owner who registered this code
    let giverUserId = null;          // who left the giver message
    let receiverUserId = null;       // who left the receiver response
    let qrAnalytics = {              // anonymous analytics for business owner
        totalScans: 0,
        giverMessages: 0,
        receiverResponses: 0,
        savedToTapestry: 0
    };

    function isBusinessOwnerViewing() {
        return isAuthenticated && qrCodeOwner && currentUser === qrCodeOwner;
    }

    function isGiverViewing() {
        return isAuthenticated && giverUserId && currentUser === giverUserId;
    }

    function isReceiverViewing() {
        return isAuthenticated && receiverUserId && currentUser === receiverUserId;
    }

    // Tapestry data (user's saved threads)
    const sampleThreads = [
        {
            id: 1, category: 'thing',
            title: 'Handmade Ceramic Mug',
            from: 'Sarah Chen',
            message: 'Happy Birthday! I made this just for you. May it bring warmth to your mornings.',
            date: '2025-01-10',
            tags: ['Birthday', 'Handmade', 'Pottery'],
            icon: '☕'
        },
        {
            id: 2, category: 'person',
            title: 'Coffee with Alex',
            from: 'Alex Rivera',
            message: "Great catching up! Let's do this again soon. Thanks for the advice on the project.",
            date: '2025-01-08',
            tags: ['Coffee', 'Meeting', 'Friends'],
            icon: '👤'
        },
        {
            id: 3, category: 'place',
            title: 'Golden Gate Park',
            from: 'Emma & Tom',
            message: 'What an amazing day exploring the park together! The botanical garden was stunning.',
            date: '2025-01-05',
            tags: ['Nature', 'SF', 'Adventure'],
            icon: '📍'
        },
        {
            id: 4, category: 'thing',
            title: 'Vintage Leather Journal',
            from: 'Grandma Rose',
            message: 'For your travels and dreams. Write your story, my dear.',
            date: '2024-12-25',
            tags: ['Gift', 'Journal', 'Travel'],
            icon: '📔'
        },
        {
            id: 5, category: 'place',
            title: 'The Blue Door Café',
            from: 'Local Discovery',
            message: 'Amazing brunch spot! Best avocado toast in the city. Perfect for weekend mornings.',
            date: '2024-12-20',
            tags: ['Food', 'Brunch', 'Local'],
            icon: '🏪'
        },
        {
            id: 6, category: 'person',
            title: 'Mom\'s Sunday Call',
            from: 'Mom',
            message: 'Remember: you are stronger than you know. Call me whenever you need to talk.',
            date: '2025-01-12',
            tags: ['Family', 'Love', 'Weekly'],
            icon: '💕'
        }
    ];

    let userThreads = [...sampleThreads]; // Start with sample data for demo

    // ==========================================
    // NAVIGATION
    // ==========================================
    function navigate(screen) {
        // Map screen names to screen IDs
        const screenMap = {
            'home':       'welcomeScreen',
            'qr':         'qrIdentityScreen',
            'qrContent':  'qrContentScreen',
            'auth':       'authScreen',
            'login':      'loginScreen',
            'signup':     'signupScreen',
            'verify':     'verifyScreen',
            'forgot':     'forgotScreen',
            'business':    'businessScreen',
            'bizProfile':  'bizProfileScreen',
            'templateEdit':'templateEditScreen',
            'bizClaim':    'bizClaimScreen',
            'giver':       'giverScreen',
            'threadView': 'threadViewScreen',
            'receiver':   'receiverScreen',
            'response':   'responseScreen',
            'success':    'successScreen',
            'tapestry':   'tapestryScreen',
            'externalQr': 'externalQrScreen',
            'threadDetail': 'threadDetailScreen'
        };

        const targetId = screenMap[screen];
        if (!targetId) { console.warn('Unknown screen:', screen); return; }

        // Track previous screen for back navigation
        const currentActive = document.querySelector('.screen.active');
        if (currentActive) previousScreen = currentActive.id;

        // Hide all screens
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));

        // Clean up verification timer if leaving verify screen
        if (previousScreen === 'verifyScreen' && targetId !== 'verifyScreen') {
            if (resendInterval) { clearInterval(resendInterval); resendInterval = null; }
        }

        // Show target
        document.getElementById(targetId).classList.add('active');
        window.scrollTo(0, 0);

        console.log('→', screen);

        // Post-navigation hooks
        if (screen === 'qr' && window.scannedQRCode) loadScannedQR(window.scannedQRCode);
        if (screen === 'qrContent') populateQRContent();
        if (screen === 'threadView') displayContent();
        if (screen === 'receiver') populateReceiver();
        if (screen === 'tapestry') initTapestry();
        if (screen === 'bizProfile') populateProfileForm();
        if (screen === 'bizClaim') initClaimScreen();
    }

    // ==========================================
    // QR SCAN FLOW
    // ==========================================
    function selectRole(role) {
        console.log('🎯 Role:', role);
        currentRole = role;
        if (isAuthenticated && scannedQRData) {
            navigate('qrContent');
        } else if (isAuthenticated) {
            navigate('qrContent');
        } else {
            navigate('auth');
        }
    }

    function handleAction(action) {
        // Block business owner from accessing personal content
        if (isBusinessOwnerViewing()) {
            console.log('🔐 Business owner blocked from personal content');
            return;
        }

        if (action === 'giver') {
            if (isAuthenticated) navigate('giver');
            else { currentRole = 'giver'; navigate('auth'); }
        }
        else if (action === 'respond') {
            // Receiver wants to respond — always needs their own account
            if (isAuthenticated) navigate('response');
            else { currentRole = 'receiver'; navigate('auth'); }
        }
        else if (action === 'editResponse') {
            if (isAuthenticated) navigate('response');
            else { currentRole = 'receiver'; navigate('auth'); }
        }
    }

    // ==========================================
    // QR SCANNER
    // ==========================================
    let html5QrScanner = null;
    let scannedExternalUrl = '';
    let extSelectedCategory = 'thing';
    let extPhotos = []; // { file, dataUrl }

    function openScanner() {
        const overlay = document.getElementById('scannerOverlay');
        overlay.classList.add('active');
        document.getElementById('manualQRInput').value = '';

        // Start camera scanner
        try {
            html5QrScanner = new Html5Qrcode('qr-reader');
            html5QrScanner.start(
                { facingMode: 'environment' }, // rear camera
                { fps: 10, qrbox: { width: 250, height: 250 } },
                (decodedText) => {
                    // QR detected — stop scanning and handle
                    closeScanner();
                    onQRDetected(decodedText);
                },
                (errorMessage) => {
                    // Scan errors are normal (no QR in frame), ignore
                }
            ).catch(err => {
                console.log('Camera unavailable:', err);
                // Camera denied or unavailable — user can still paste URL
            });
        } catch (e) {
            console.log('Scanner init error:', e);
        }
    }

    function closeScanner() {
        const overlay = document.getElementById('scannerOverlay');
        overlay.classList.remove('active');

        if (html5QrScanner) {
            html5QrScanner.stop().then(() => {
                html5QrScanner.clear();
            }).catch(() => {});
            html5QrScanner = null;
        }
    }

    function handleManualURL() {
        const url = document.getElementById('manualQRInput').value.trim();
        if (!url) return;
        closeScanner();
        onQRDetected(url);
    }

    function isDuyenURL(url) {
        // Match duyen.io, dayduyen.tech, or localhost test URLs
        return url.includes('duyen.io/q/') ||
               url.includes('dayduyen.tech') ||
               url.includes('duyen.io/#') ||
               url.includes('localhost') && url.includes('duyen');
    }

    function onQRDetected(decodedText) {
        console.log('📸 Scanned:', decodedText);

        if (isDuyenURL(decodedText)) {
            // Duyên code — go to the existing flow
            console.log('🧵 Duyên code detected');
            businessData = {};
            giverData = {};
            responseData = {};
            qrCodeOwner = null;
            giverUserId = null;
            receiverUserId = null;
            qrAnalytics = { totalScans: 0, giverMessages: 0, receiverResponses: 0, savedToTapestry: 0 };
            navigate('qr');
        } else {
            // External QR code — show landing with choices
            console.log('🌐 External QR code');
            scannedExternalUrl = decodedText;
            showExternalScanLanding(decodedText);
        }
    }

    function showExternalScanLanding(url) {
        // Build a nice domain display
        let displayDomain = url;
        try {
            const urlObj = new URL(url);
            displayDomain = urlObj.hostname.replace('www.', '');
        } catch(e) {}

        const container = document.getElementById('threadDetailContent');
        container.innerHTML = `
            <div style="text-align: center; padding: 2rem 0 1.5rem;">
                <div style="font-size: 3.5rem; margin-bottom: 0.75rem;">📸</div>
                <h2 style="font-family: 'Crimson Pro', serif; font-size: 1.75rem; color: var(--text-primary); margin-bottom: 0.25rem;">QR Code Scanned!</h2>
                <p class="subtitle">This isn't a Duyên code — it links to:</p>
            </div>

            <div class="scan-landing-url">
                <div style="font-size: 2.5rem;">🔗</div>
                <div style="font-weight: 700; font-size: 1.1rem; color: var(--text-primary); margin-top: 0.5rem;">${displayDomain}</div>
                <div class="url-text">${url}</div>
            </div>

            <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 1.5rem;">
                <a href="${url}" target="_blank" rel="noopener noreferrer" class="btn btn-secondary" style="width: 100%; text-decoration: none; display: block; box-sizing: border-box;">
                    🌐 Open Link
                </a>
                <button class="btn btn-primary" onclick="promptSaveExternal()" style="width: 100%;">
                    🧵 Save to My Tapestry
                </button>
                <button class="btn btn-secondary" onclick="navigate('tapestry')" style="width: 100%; border: none; color: var(--text-muted);">
                    Skip
                </button>
            </div>

            <div style="text-align: center; padding: 1rem; background: var(--soft-sand); border-radius: 14px;">
                <p style="font-size: 0.85rem; color: var(--text-secondary); margin: 0;">
                    💡 Saving this QR code weaves it into the tapestry of your life — a personal record of where you've been and what you've experienced.
                </p>
            </div>
        `;

        navigate('threadDetail');
    }

    function promptSaveExternal() {
        if (!isAuthenticated) {
            currentRole = 'receiver';
            window.postAuthDestination = 'externalQr';
            navigate('auth');
            return;
        }
        openExternalQrPage(scannedExternalUrl);
    }

    function openExternalQrPage(url) {
        scannedExternalUrl = url;
        extSelectedCategory = 'thing';
        extPhotos = [];

        // Populate screen
        document.getElementById('externalUrl').textContent = url;

        // Auto-suggest title from URL
        let suggestedTitle = '';
        try {
            const urlObj = new URL(url);
            suggestedTitle = urlObj.hostname.replace('www.', '').split('.')[0];
            suggestedTitle = suggestedTitle.charAt(0).toUpperCase() + suggestedTitle.slice(1);
            const path = urlObj.pathname.replace(/\//g, ' ').trim();
            if (path) suggestedTitle += ' — ' + path.charAt(0).toUpperCase() + path.slice(1);
        } catch(e) {
            suggestedTitle = url.substring(0, 40);
        }
        document.getElementById('extTitle').value = suggestedTitle;

        document.getElementById('extNotes').value = '';
        document.getElementById('extFrom').value = '';
        document.getElementById('extTags').value = '';
        document.getElementById('extPhotoPreview').innerHTML = '';
        document.getElementById('extPhotoCount').textContent = '';
        
        // Clear any previous validation error
        document.getElementById('extTitleError').style.display = 'none';
        document.getElementById('extTitle').style.borderColor = '';

        // Reset category picker
        document.querySelectorAll('.category-option').forEach(c => c.classList.remove('selected'));
        document.querySelector('.category-option').classList.add('selected');

        navigate('externalQr');
    }

    function selectCategory(cat, el) {
        extSelectedCategory = cat;
        document.querySelectorAll('.category-picker .category-option').forEach(c => c.classList.remove('selected'));
        el.classList.add('selected');
    }

    function handleExtPhotos(input) {
        const files = Array.from(input.files);
        files.forEach(file => {
            const reader = new FileReader();
            reader.onload = function(e) {
                extPhotos.push({ file: file, dataUrl: e.target.result });
                renderExtPhotoPreview();
            };
            reader.readAsDataURL(file);
        });
        input.value = ''; // Reset so same file can be re-selected
    }

    function renderExtPhotoPreview() {
        const container = document.getElementById('extPhotoPreview');
        container.innerHTML = '';
        document.getElementById('extPhotoCount').textContent = extPhotos.length > 0 ? extPhotos.length + ' photo' + (extPhotos.length > 1 ? 's' : '') : '';

        extPhotos.forEach((photo, idx) => {
            const div = document.createElement('div');
            div.className = 'photo-preview-item';
            div.innerHTML = `
                <img src="${photo.dataUrl}" alt="Photo ${idx + 1}">
                <button class="remove-photo" onclick="removeExtPhoto(${idx})">✕</button>
            `;
            container.appendChild(div);
        });
    }

    function removeExtPhoto(idx) {
        extPhotos.splice(idx, 1);
        renderExtPhotoPreview();
    }

    function saveExternalScan() {
        const titleEl = document.getElementById('extTitle');
        const title = titleEl.value.trim();
        const errorEl = document.getElementById('extTitleError');

        if (!title) {
            errorEl.style.display = 'block';
            titleEl.style.borderColor = 'var(--brand-red)';
            titleEl.focus();
            return;
        }

        errorEl.style.display = 'none';
        titleEl.style.borderColor = '';

        const notes = document.getElementById('extNotes').value.trim();
        const from = document.getElementById('extFrom').value.trim();
        const tagsRaw = document.getElementById('extTags').value.trim();
        const tags = tagsRaw ? tagsRaw.split(',').map(t => t.trim()).filter(Boolean) : [];

        const icons = { thing: '🎁', person: '👤', place: '📍' };

        const newThread = {
            id: Date.now(),
            category: extSelectedCategory,
            title: title,
            from: from || 'Scanned QR',
            message: notes || 'Saved from a QR code scan.',
            date: new Date().toISOString().split('T')[0],
            tags: tags.length > 0 ? tags : ['Scan'],
            icon: icons[extSelectedCategory] || '📌',
            source: 'external_scan',
            externalUrl: scannedExternalUrl,
            photos: extPhotos.map(p => p.dataUrl),
            isHidden: false
        };

        userThreads.unshift(newThread);
        console.log('📌 External scan saved to tapestry:', newThread);

        document.getElementById('successMsg').textContent = 'Woven into your tapestry! This moment is now part of the days of your life.';
        navigate('success');
    }

    // Keep simulateScan for test journeys
    function simulateScan() {
        businessData = {};
        giverData = {};
        responseData = {};
        qrCodeOwner = null;
        giverUserId = null;
        receiverUserId = null;
        qrAnalytics = { totalScans: 0, giverMessages: 0, receiverResponses: 0, savedToTapestry: 0 };
        navigate('qr');
    }

    // ==========================================
    // AUTH
    // ==========================================
    function handleGoogleAuth() {
        console.log('🔵 Google auth');
        simulateAuthSuccess('Google User');
    }

    function handleAppleAuth() {
        console.log('🍎 Apple auth');
        simulateAuthSuccess('Apple User');
    }

    // SUPABASE
    // If returning from logout, wipe storage before Supabase initializes
    if (window.location.search.includes('logged_out=')) {
        document.cookie.split(';').forEach(function(c) {
            var name = c.split('=')[0].trim();
            document.cookie = name + '=; path=/; max-age=0';
        });
        try { localStorage.clear(); } catch(e) {}
        try { sessionStorage.clear(); } catch(e) {}
        window.history.replaceState({}, '', window.location.origin);
    }

    const _supabase = window.supabase.createClient(
        'https://qnlaaieyipeglfuepmor.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFubGFhaWV5aXBlZ2xmdWVwbW9yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0NjAxNjgsImV4cCI6MjA4NzAzNjE2OH0.jwAH8E93iPlBJyYuF-HfoB52jVxNLiR2LL64gfqppa8'
    );

    function logoutDuyen() {
        try { _supabase.auth.signOut({ scope: 'global' }); } catch(e) {}
        document.cookie.split(';').forEach(function(c) {
            var name = c.split('=')[0].trim();
            document.cookie = name + '=; path=/; max-age=0';
        });
        try { localStorage.clear(); } catch(e) {}
        try { sessionStorage.clear(); } catch(e) {}
        window.location.replace(window.location.origin + '?logged_out=' + Date.now());
    }

    // Fetch QR code data from Supabase and display it
    // Store fetched QR data globally so role screens can use it later
    var scannedQRData = null;

    async function loadScannedQR(code) {
        const notFound = document.getElementById('qrNotFound');
        const bizOption = document.getElementById('roleBusinessOption');
        notFound.style.display = 'none';
        bizOption.style.display = 'block';
        
        try {
            const searchUrl = 'https://duyen.io/q/' + code;
            let data = null;
            
            // Try matching by url first
            const r1 = await _supabase.from('qr_codes').select('*').eq('url', searchUrl).limit(1);
            if (r1.data && r1.data.length > 0) {
                data = r1.data[0];
            } else {
                // Try matching by id (UUID)
                const r2 = await _supabase.from('qr_codes').select('*').eq('id', code).limit(1);
                if (r2.data && r2.data.length > 0) {
                    data = r2.data[0];
                }
            }
            
            if (!data) {
                notFound.style.display = 'block';
                return;
            }
            
            // Store data for later use after role selection
            scannedQRData = data;
            
            // If business has added content, hide the business option
            // A blank QR only has a default label — no details, media, or photo
            var hasBusinessContent = data.business_data || data.business_user_id;
            var hasDetails = data.details && data.details.trim().length > 0;
            var hasMedia = false;
            try { 
                var m = typeof data.media === 'string' ? JSON.parse(data.media) : (data.media || []);
                hasMedia = m.length > 0;
            } catch(e) {}
            var hasPhoto = data.photo && data.photo.length > 0;
            
            if (hasBusinessContent || hasDetails || hasMedia || hasPhoto) {
                bizOption.style.display = 'none';
            }
            
        } catch(e) {
            console.error('Error loading QR:', e);
        }
    }

    var bizPhotoData = null;
    var giverPhotoFiles = [];

    function handleBizPhoto(input) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            reader.onload = function(e) {
                bizPhotoData = e.target.result;
                var preview = document.getElementById('qcBizPhotoPreview');
                preview.innerHTML = '<img src="' + e.target.result + '" style="max-width:200px;border-radius:12px;border:2px solid var(--border-light);">';
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    async function saveBusinessData() {
        if (!scannedQRData) return;
        var name = document.getElementById('qcBizName').value.trim();
        if (!name) { alert('Please enter a business name'); return; }
        
        var businessData = {
            name: name,
            description: document.getElementById('qcBizDesc').value.trim(),
            email: document.getElementById('qcBizEmail').value.trim(),
            phone: document.getElementById('qcBizPhone').value.trim(),
            photo: bizPhotoData,
            date: new Date().toISOString()
        };
        
        try {
            var userId = (await _supabase.auth.getUser()).data.user.id;
            var updateFields = {
                business_data: businessData,
                business_user_id: userId,
                label: name,
                details: businessData.description
            };
            if (bizPhotoData) updateFields.photo = bizPhotoData;
            
            var { error } = await _supabase
                .from('qr_codes')
                .update(updateFields)
                .eq('id', scannedQRData.id);
            
            if (error) {
                console.error('Save business error:', error);
                alert('Error saving. Please try again.');
                return;
            }
            
            scannedQRData.business_data = businessData;
            scannedQRData.business_user_id = userId;
            scannedQRData.label = name;
            scannedQRData.details = businessData.description;
            populateQRContent(); // Will now show locked screen
        } catch(e) {
            console.error('Save business error:', e);
            alert('Error saving. Please try again.');
        }
    }

    function populateQRContent() {
        var data = scannedQRData || {};
        
        // Hide all sections first
        document.getElementById('qcBizSection').style.display = 'none';
        document.getElementById('qcBizForm').style.display = 'none';
        document.getElementById('qcGiverForm').style.display = 'none';
        document.getElementById('qcGiverSent').style.display = 'none';
        document.getElementById('qcReceiverView').style.display = 'none';
        document.getElementById('qcBizLocked').style.display = 'none';
        
        // Show business info if it exists (for giver/receiver to see)
        if (data.label || data.details || data.photo) {
            var bizSection = document.getElementById('qcBizSection');
            bizSection.style.display = 'block';
            document.getElementById('qcBizLabel').textContent = data.label || '';
            document.getElementById('qcBizDetails').textContent = data.details || '';
            
            if (data.photo) {
                document.getElementById('qcBizPhotoImg').src = data.photo;
                document.getElementById('qcBizPhoto').style.display = 'block';
            } else {
                document.getElementById('qcBizPhoto').style.display = 'none';
            }
            
            // Show media
            var mediaGrid = document.getElementById('qcBizMedia');
            var mediaItems = [];
            try { mediaItems = typeof data.media === 'string' ? JSON.parse(data.media) : (data.media || []); } catch(e) {}
            if (mediaItems.length > 0) {
                mediaGrid.innerHTML = mediaItems.map(function(m) {
                    var src = m.url || m.dataUrl || m;
                    return '<img src="' + src + '" alt="Media" style="cursor:pointer;" onclick="window.open(this.src)">';
                }).join('');
                mediaGrid.style.display = 'grid';
            } else {
                mediaGrid.style.display = 'none';
            }
        }
        
        // Role-specific content
        if (currentRole === 'business') {
            if (data.business_data || data.business_user_id) {
                // Already claimed — show locked
                document.getElementById('qcBizLocked').style.display = 'block';
            } else {
                // Show form to add business info
                document.getElementById('qcBizForm').style.display = 'block';
                // Pre-fill with existing QR data if any
                document.getElementById('qcBizName').value = data.label || '';
                document.getElementById('qcBizDesc').value = data.details || '';
            }
        }
        else if (currentRole === 'giver') {
            if (data.giver_data) {
                // Giver already added message — show it + receiver response
                var giverData = typeof data.giver_data === 'string' ? JSON.parse(data.giver_data) : data.giver_data;
                document.getElementById('qcGiverSent').style.display = 'block';
                document.getElementById('qcGiverSentMessage').textContent = giverData.message || '';
                
                if (data.receiver_data) {
                    var recData = typeof data.receiver_data === 'string' ? JSON.parse(data.receiver_data) : data.receiver_data;
                    document.getElementById('qcReceiverResponse').style.display = 'block';
                    document.getElementById('qcReceiverMessage').textContent = recData.message || '';
                    document.getElementById('qcGiverWaiting').style.display = 'none';
                } else {
                    document.getElementById('qcReceiverResponse').style.display = 'none';
                    document.getElementById('qcGiverWaiting').style.display = 'block';
                }
            } else {
                // Giver hasn't added message yet — show form
                document.getElementById('qcGiverForm').style.display = 'block';
            }
        }
        else if (currentRole === 'receiver') {
            document.getElementById('qcReceiverView').style.display = 'block';
            
            if (data.giver_data) {
                var gData = typeof data.giver_data === 'string' ? JSON.parse(data.giver_data) : data.giver_data;
                document.getElementById('qcGiverMessageView').style.display = 'block';
                document.getElementById('qcGiverMsgContent').textContent = gData.message || '';
                
                // Show giver photos if any
                var gPhotos = document.getElementById('qcGiverMsgPhotos');
                if (gData.photos && gData.photos.length > 0) {
                    gPhotos.innerHTML = gData.photos.map(function(p) {
                        return '<img src="' + p + '" alt="Gift photo" onclick="window.open(this.src)">';
                    }).join('');
                    gPhotos.style.display = 'grid';
                } else {
                    gPhotos.style.display = 'none';
                }
            } else {
                document.getElementById('qcGiverMessageView').style.display = 'none';
            }
            
            if (data.receiver_data) {
                // Already sent thank you
                document.getElementById('qcReceiverForm').style.display = 'none';
                document.getElementById('qcReceiverSent').style.display = 'block';
            } else {
                document.getElementById('qcReceiverForm').style.display = 'block';
                document.getElementById('qcReceiverSent').style.display = 'none';
            }
        }
    }

    function handleGiverPhotos(input) {
        var files = Array.from(input.files);
        var preview = document.getElementById('qcGiverPhotoPreview');
        files.forEach(function(file) {
            var reader = new FileReader();
            reader.onload = function(e) {
                giverPhotoFiles.push(e.target.result);
                var img = document.createElement('img');
                img.src = e.target.result;
                img.style.cssText = 'width:70px;height:70px;object-fit:cover;border-radius:10px;border:2px solid var(--border-light);';
                preview.appendChild(img);
            };
            reader.readAsDataURL(file);
        });
    }

    async function saveGiverData() {
        if (!scannedQRData) return;
        var message = document.getElementById('qcGiverMessage').value.trim();
        if (!message) { alert('Please write a message'); return; }
        
        var giverData = {
            message: message,
            photos: giverPhotoFiles,
            user: currentUser,
            date: new Date().toISOString()
        };
        
        try {
            var { error } = await _supabase
                .from('qr_codes')
                .update({ giver_data: giverData, giver_user_id: (await _supabase.auth.getUser()).data.user.id })
                .eq('id', scannedQRData.id);
            
            if (error) {
                console.error('Save giver error:', error);
                alert('Error saving. Please try again.');
                return;
            }
            
            scannedQRData.giver_data = giverData;
            populateQRContent();
        } catch(e) {
            console.error('Save giver error:', e);
            alert('Error saving. Please try again.');
        }
    }

    async function saveReceiverData() {
        if (!scannedQRData) return;
        var note = document.getElementById('qcReceiverNote').value.trim();
        if (!note) { alert('Please write a thank you note'); return; }
        
        var receiverData = {
            message: note,
            user: currentUser,
            date: new Date().toISOString()
        };
        
        try {
            var { error } = await _supabase
                .from('qr_codes')
                .update({ receiver_data: receiverData, receiver_user_id: (await _supabase.auth.getUser()).data.user.id })
                .eq('id', scannedQRData.id);
            
            if (error) {
                console.error('Save receiver error:', error);
                alert('Error saving. Please try again.');
                return;
            }
            
            scannedQRData.receiver_data = receiverData;
            populateQRContent();
        } catch(e) {
            console.error('Save receiver error:', e);
            alert('Error saving. Please try again.');
        }
    }

    async function saveToTapestry() {
        if (!isAuthenticated) {
            navigate('auth');
            return;
        }
        if (!scannedQRData) {
            alert('No QR data to save');
            return;
        }
        alert('Saved to your tapestry! 🧵');
    }

    _supabase.auth.getSession().then(({ data: { session } }) => {
        if (session && session.user) {
            // Set auth state but DON'T navigate if we're on a QR scan URL
            isAuthenticated = true;
            currentUser = session.user.email.split('@')[0];
            const tapTitle = document.getElementById('tapestryTitle');
            const displayName = currentUser.includes('@') ? currentUser.split('@')[0] : currentUser.split(' ')[0];
            tapTitle.textContent = displayName + '\'s Tapestry';
            
            // Only auto-navigate to tapestry if NOT on a QR scan URL
            const path = window.location.pathname;
            const hash = window.location.hash;
            if (!path.startsWith('/q/') && !hash.startsWith('#/q/')) {
                proceedAfterAuth();
            }
        }
    });

    async function handleLogin() {
        const email = document.getElementById('loginEmail').value;
        const pw = document.getElementById('loginPassword').value;
        if (!email || !pw) { alert('Please enter email and password'); return; }
        const btn = document.querySelector('#loginScreen .btn-primary');
        btn.disabled = true; btn.textContent = 'Signing in...';
        const { data, error } = await _supabase.auth.signInWithPassword({ email, password: pw });
        btn.disabled = false; btn.textContent = 'Sign In';
        if (error) { alert('Login failed: ' + error.message); return; }
        simulateAuthSuccess(data.user.email.split('@')[0]);
    }

    // ==========================================
    // SIGNUP + EMAIL VERIFICATION
    // ==========================================
    let signupUserData = {};   // Stores signup info until verified
    let verificationCode = ''; // The "sent" code
    let resendInterval = null;
    let resendCountdown = 0;
    let verifyAttempts = 0;
    const MAX_VERIFY_ATTEMPTS = 5;

    function generateCode() {
        return String(Math.floor(100000 + Math.random() * 900000));
    }

    async function handleSignup() {
        const name = document.getElementById('signupName').value.trim();
        const email = document.getElementById('signupEmail').value.trim();
        const pw = document.getElementById('signupPassword').value;
        const confirm = document.getElementById('signupConfirm').value;
        if (!name) { showSignupError('signupName', 'Please enter your name'); return; }
        if (!email || !isValidEmail(email)) { showSignupError('signupEmail', 'Please enter a valid email'); return; }
        if (!pw || pw.length < 8) { showSignupError('signupPassword', 'Password must be at least 8 characters'); return; }
        if (pw !== confirm) { showSignupError('signupConfirm', 'Passwords do not match'); return; }
        const btn = document.querySelector('#signupScreen .btn-primary');
        btn.disabled = true; btn.textContent = 'Creating account...';
        const { data, error } = await _supabase.auth.signUp({
            email, password: pw, options: { data: { full_name: name } }
        });
        btn.disabled = false; btn.textContent = 'Create Account';
        if (error) { alert('Signup failed: ' + error.message); return; }
        signupUserData = { name, email, password: pw };
        document.getElementById('verifyEmailDisplay').textContent = email;
        document.getElementById('demoCodeDisplay').textContent = '(check your email for a verification link)';
        document.getElementById('verifySuccessOverlay').style.display = 'none';
        clearCodeInputs();
        navigate('verify');
        startResendTimer(30);
        setTimeout(() => { document.getElementById('code1').focus(); }, 500);
    }

    function isValidEmail(email) {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    function showSignupError(inputId, message) {
        const input = document.getElementById(inputId);
        input.style.borderColor = '#e53935';
        input.focus();
        // Brief shake
        input.style.animation = 'codeShake 0.4s ease';
        setTimeout(() => { input.style.animation = ''; }, 400);
        alert(message);
        // Reset border on next input
        input.addEventListener('input', function reset() {
            input.style.borderColor = '';
            input.removeEventListener('input', reset);
        });
    }

    function handleVerification() {
        const inputs = getCodeInputs();
        const code = inputs.map(i => i.value).join('');

        if (code.length !== 6) {
            setVerifyStatus('Please enter all 6 digits', 'error');
            return;
        }

        if (verifyAttempts >= MAX_VERIFY_ATTEMPTS) {
            setVerifyStatus('Too many attempts. Please request a new code.', 'error');
            return;
        }

        verifyAttempts++;

        // Show loading state
        const btn = document.getElementById('verifyBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="verify-loading"><span class="verify-spinner"></span> Verifying...</span>';
        setVerifyStatus('', '');

        // Simulate server verification delay
        setTimeout(() => {
            if (code === verificationCode) {
                // SUCCESS
                console.log('✅ Email verified for:', signupUserData.email);
                inputs.forEach(i => { i.classList.remove('error'); i.classList.add('success'); });
                setVerifyStatus('', 'success');

                // Show success overlay
                setTimeout(() => {
                    const overlay = document.getElementById('verifySuccessOverlay');
                    document.getElementById('verifySuccessName').textContent =
                        'Welcome, ' + signupUserData.name + '!';
                    overlay.style.display = 'flex';

                    // Proceed after showing success
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.innerHTML = 'Verify Email';
                        simulateAuthSuccess(signupUserData.name);
                    }, 1800);
                }, 400);

            } else {
                // WRONG CODE
                console.log('❌ Wrong code. Entered:', code, 'Expected:', verificationCode);
                inputs.forEach(i => { i.classList.add('error'); i.classList.remove('filled'); });

                const remaining = MAX_VERIFY_ATTEMPTS - verifyAttempts;
                if (remaining > 0) {
                    setVerifyStatus(
                        'Incorrect code. ' + remaining + ' attempt' + (remaining !== 1 ? 's' : '') + ' remaining.',
                        'error'
                    );
                } else {
                    setVerifyStatus('Too many attempts. Please request a new code.', 'error');
                }

                btn.disabled = false;
                btn.innerHTML = 'Verify Email';

                // Clear inputs and refocus after a beat
                setTimeout(() => {
                    clearCodeInputs();
                    document.getElementById('code1').focus();
                }, 800);
            }
        }, 1200); // Simulated network delay
    }

    function setVerifyStatus(message, type) {
        const el = document.getElementById('verifyStatus');
        el.textContent = message;
        el.className = 'verify-status' + (type ? ' ' + type : '');
    }

    // ==========================================
    // CODE INPUT HANDLING
    // ==========================================
    function getCodeInputs() {
        return [1,2,3,4,5,6].map(n => document.getElementById('code' + n));
    }

    function clearCodeInputs() {
        getCodeInputs().forEach(input => {
            input.value = '';
            input.classList.remove('filled', 'error', 'success');
        });
        setVerifyStatus('', '');
    }

    function initCodeInputs() {
        const inputs = getCodeInputs();

        inputs.forEach((input, index) => {
            // Only allow numbers
            input.addEventListener('input', function(e) {
                // Strip non-numeric
                this.value = this.value.replace(/[^0-9]/g, '');

                if (this.value.length === 1) {
                    this.classList.add('filled');
                    this.classList.remove('error');
                    // Auto-advance
                    if (index < 5) {
                        inputs[index + 1].focus();
                    } else {
                        // Last digit entered — auto-verify
                        this.blur();
                        setTimeout(() => handleVerification(), 200);
                    }
                } else {
                    this.classList.remove('filled');
                }
            });

            // Backspace handling
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Backspace') {
                    if (this.value === '' && index > 0) {
                        // Move back to previous input
                        inputs[index - 1].value = '';
                        inputs[index - 1].classList.remove('filled');
                        inputs[index - 1].focus();
                        e.preventDefault();
                    } else {
                        this.classList.remove('filled');
                    }
                }

                // Arrow key navigation
                if (e.key === 'ArrowLeft' && index > 0) {
                    inputs[index - 1].focus();
                    e.preventDefault();
                }
                if (e.key === 'ArrowRight' && index < 5) {
                    inputs[index + 1].focus();
                    e.preventDefault();
                }

                // Enter to verify
                if (e.key === 'Enter') {
                    handleVerification();
                }
            });

            // Select all on focus for easy replacement
            input.addEventListener('focus', function() {
                this.select();
            });
        });

        // Paste support — paste full 6-digit code at once
        inputs[0].addEventListener('paste', function(e) {
            e.preventDefault();
            const pasted = (e.clipboardData || window.clipboardData).getData('text').trim();
            const digits = pasted.replace(/[^0-9]/g, '');

            if (digits.length >= 6) {
                inputs.forEach((input, i) => {
                    input.value = digits[i] || '';
                    if (input.value) input.classList.add('filled');
                });
                inputs[5].focus();
                // Auto-verify after paste
                setTimeout(() => handleVerification(), 300);
            }
        });
    }

    // ==========================================
    // RESEND TIMER
    // ==========================================
    function startResendTimer(seconds) {
        // Clear any existing timer
        if (resendInterval) clearInterval(resendInterval);

        resendCountdown = seconds;
        const btn = document.getElementById('resendBtn');
        const timerSpan = document.getElementById('resendTimer');

        btn.disabled = true;
        btn.innerHTML = 'Resend in <span id="resendTimer">' + resendCountdown + '</span>s';

        resendInterval = setInterval(() => {
            resendCountdown--;
            const currentTimerSpan = document.getElementById('resendTimer');
            if (currentTimerSpan) {
                currentTimerSpan.textContent = resendCountdown;
            }

            if (resendCountdown <= 0) {
                clearInterval(resendInterval);
                resendInterval = null;
                btn.disabled = false;
                btn.textContent = 'Resend Code';
            }
        }, 1000);
    }

    function resendCode() {
        // Generate a new code
        verificationCode = generateCode();
        verifyAttempts = 0;
        console.log('📧 New verification code "sent":', verificationCode);

        // Update demo hint
        document.getElementById('demoCodeDisplay').textContent = verificationCode;

        // Clear inputs
        clearCodeInputs();

        // Show confirmation
        setVerifyStatus('New code sent! Check your email.', 'success');
        setTimeout(() => setVerifyStatus('', ''), 3000);

        // Restart timer
        startResendTimer(30);

        // Focus first input
        document.getElementById('code1').focus();
    }

    function handleForgotPassword() {
        const email = document.getElementById('resetEmail').value;
        if (!email) { alert('Please enter your email'); return; }
        alert('Reset link sent to ' + email);
        navigate('login');
    }

    function skipAuth() {
        console.log('👤 Guest mode');
        proceedAfterAuth();
    }

    function simulateAuthSuccess(user) {
        console.log('✅ Auth:', user);
        isAuthenticated = true;
        currentUser = user;

        // Update tapestry title if we have a name
        const tapTitle = document.getElementById('tapestryTitle');
        const displayName = user.includes('@') ? user.split('@')[0] : user.split(' ')[0];
        tapTitle.textContent = displayName + '\'s Tapestry';

        proceedAfterAuth();
    }

    function proceedAfterAuth() {
        // Check if we need to return to external QR note page
        if (window.postAuthDestination === 'externalQr') {
            window.postAuthDestination = null;
            openExternalQrPage(scannedExternalUrl);
            return;
        }

        // If we have scanned QR data, go to content screen
        if (scannedQRData && currentRole) {
            navigate('qrContent');
            return;
        }

        if (currentRole === 'business') {
            if (businessProfile) {
                navigate('bizClaim');
            } else {
                navigate('bizProfile');
            }
        }
        else if (currentRole === 'giver') navigate('giver');
        else if (currentRole === 'receiver') navigate('threadView');
        else navigate('tapestry');
    }

    function togglePassword(id) {
        const el = document.getElementById(id);
        el.type = el.type === 'password' ? 'text' : 'password';
    }

    // ==========================================
    // BUSINESS FORM
    // ==========================================
    function addLink() {
        const container = document.getElementById('linksContainer');
        const div = document.createElement('div');
        div.className = 'link-row';
        div.innerHTML = `
            <input type="url" placeholder="https://another-link.com" data-link>
            <button type="button" class="btn-icon" onclick="this.parentElement.remove()">×</button>
        `;
        container.appendChild(div);
    }

    function saveBusiness() {
        const name = document.getElementById('bizName').value;
        if (!name) { alert('Please enter a business name'); return; }

        businessData = {
            businessName: name,
            productName: document.getElementById('prodName').value,
            description: document.getElementById('bizDesc').value,
            email: document.getElementById('bizEmail').value,
            phone: document.getElementById('bizPhone').value,
            links: Array.from(document.querySelectorAll('[data-link]')).map(i => i.value).filter(v => v),
            media: mediaFiles.biz,
            files: docFiles
        };

        // Register this user as the business owner of this QR code
        qrCodeOwner = currentUser;
        console.log('💾 Business saved:', businessData);
        console.log('🔐 QR code registered to:', qrCodeOwner);
        navigate('threadView');
    }

    // ==========================================
    // BUSINESS PROFILE
    // ==========================================
    function addProfileLink() {
        const container = document.getElementById('profileLinksContainer');
        const div = document.createElement('div');
        div.className = 'link-row';
        div.innerHTML = `
            <input type="url" placeholder="https://another-link.com" data-profile-link>
            <button type="button" class="btn-icon" onclick="this.parentElement.remove()">×</button>
        `;
        container.appendChild(div);
    }

    function saveBusinessProfile() {
        const name = document.getElementById('profileBizName').value.trim();
        if (!name) { alert('Please enter your business name'); return; }

        const links = Array.from(document.querySelectorAll('[data-profile-link]'))
            .map(i => i.value.trim()).filter(v => v);

        // Preserve existing templates if editing
        const existingTemplates = businessProfile ? businessProfile.templates : [];

        businessProfile = {
            name: name,
            email: document.getElementById('profileEmail').value.trim(),
            phone: document.getElementById('profilePhone').value.trim(),
            links: links,
            media: mediaFiles.profile,
            templates: existingTemplates
        };

        console.log('💼 Business profile saved:', businessProfile);

        // If we came here to set up before claiming, go to claim
        if (currentRole === 'business') {
            navigate('bizClaim');
        } else {
            navigate('tapestry');
        }
    }

    function populateProfileForm() {
        if (!businessProfile) return;
        document.getElementById('profileBizName').value = businessProfile.name || '';
        document.getElementById('profileEmail').value = businessProfile.email || '';
        document.getElementById('profilePhone').value = businessProfile.phone || '';

        // Links
        const container = document.getElementById('profileLinksContainer');
        container.innerHTML = '';
        const profileLinks = businessProfile.links && businessProfile.links.length > 0
            ? businessProfile.links : [''];
        profileLinks.forEach((link, i) => {
            const div = document.createElement('div');
            div.className = 'link-row';
            div.innerHTML = `
                <input type="url" placeholder="https://your-website.com" data-profile-link value="${link}">
                <button type="button" class="btn-icon" onclick="${i === 0 ? 'addProfileLink()' : 'this.parentElement.remove()'}">${i === 0 ? '+' : '×'}</button>
            `;
            container.appendChild(div);
        });

        // Render templates
        renderProfileTemplates();
    }

    function renderProfileTemplates() {
        const grid = document.getElementById('profileTemplateGrid');
        grid.innerHTML = '';

        if (businessProfile && businessProfile.templates) {
            businessProfile.templates.forEach((tpl, i) => {
                const card = document.createElement('div');
                card.className = 'template-card';
                card.onclick = () => editTemplate(i);
                card.innerHTML = `
                    <div class="template-icon">${tpl.icon || '📦'}</div>
                    <div class="template-name">${tpl.productName}</div>
                    <div class="template-desc">${tpl.description || 'No description'}</div>
                    <div class="template-meta">
                        ${tpl.media && tpl.media.length > 0 ? `<span class="template-meta-pill">📸 ${tpl.media.length} media</span>` : ''}
                        ${tpl.files && tpl.files.length > 0 ? `<span class="template-meta-pill">📄 ${tpl.files.length} files</span>` : ''}
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // "Add new" card
        const addCard = document.createElement('div');
        addCard.className = 'template-add-card';
        addCard.onclick = () => editTemplate(-1);
        addCard.innerHTML = `
            <div class="template-add-icon">+</div>
            <div class="template-add-label">New Template</div>
        `;
        grid.appendChild(addCard);
    }

    // ==========================================
    // TEMPLATE EDITOR
    // ==========================================
    function editTemplate(index) {
        editingTemplateIndex = index;
        mediaFiles.tpl = [];
        tplDocFiles = [];

        // Clear form
        document.getElementById('tplProdName').value = '';
        document.getElementById('tplDesc').value = '';
        document.getElementById('tplPreviews').innerHTML = '';
        document.getElementById('tplFilesList').innerHTML = '';
        selectedIcon = '💐';
        document.getElementById('selectedIcon').textContent = selectedIcon;

        if (index >= 0 && businessProfile && businessProfile.templates[index]) {
            const tpl = businessProfile.templates[index];
            document.getElementById('templateEditTitle').textContent = 'Edit Template';
            document.getElementById('tplProdName').value = tpl.productName || '';
            document.getElementById('tplDesc').value = tpl.description || '';
            selectedIcon = tpl.icon || '💐';
            document.getElementById('selectedIcon').textContent = selectedIcon;
            mediaFiles.tpl = tpl.media ? [...tpl.media] : [];
            tplDocFiles = tpl.files ? [...tpl.files] : [];
        } else {
            document.getElementById('templateEditTitle').textContent = 'New Product Template';
        }

        navigate('templateEdit');
    }

    function pickIcon(icon) {
        selectedIcon = icon;
        document.getElementById('selectedIcon').textContent = icon;
    }

    function saveTemplate() {
        const name = document.getElementById('tplProdName').value.trim();
        if (!name) { alert('Please enter a product name'); return; }

        const template = {
            productName: name,
            description: document.getElementById('tplDesc').value.trim(),
            icon: selectedIcon,
            media: mediaFiles.tpl,
            files: tplDocFiles
        };

        if (!businessProfile) {
            businessProfile = { name: '', email: '', phone: '', links: [], media: [], templates: [] };
        }

        if (editingTemplateIndex >= 0) {
            businessProfile.templates[editingTemplateIndex] = template;
            console.log('📝 Template updated:', template.productName);
        } else {
            businessProfile.templates.push(template);
            console.log('➕ Template added:', template.productName);
        }

        navigate('bizProfile');
        // Re-render templates after navigation
        setTimeout(renderProfileTemplates, 100);
    }

    // ==========================================
    // QR CLAIM FLOW
    // ==========================================
    function initClaimScreen() {
        if (!businessProfile) return;

        selectedTemplateIndex = -1;

        // Populate profile summary
        document.getElementById('claimBizName').textContent = businessProfile.name;
        document.getElementById('claimBizEmail').textContent = businessProfile.email || '—';
        document.getElementById('claimBizPhone').textContent = businessProfile.phone || '—';

        const linksEl = document.getElementById('claimBizLinks');
        linksEl.innerHTML = '';
        if (businessProfile.links) {
            businessProfile.links.forEach(link => {
                let short = link.replace(/^https?:\/\/(www\.)?/, '').split('/')[0];
                linksEl.innerHTML += `<span class="profile-link-pill">🔗 ${short}</span>`;
            });
        }

        // Populate template grid
        const grid = document.getElementById('claimTemplateGrid');
        grid.innerHTML = '';

        if (businessProfile.templates && businessProfile.templates.length > 0) {
            businessProfile.templates.forEach((tpl, i) => {
                const card = document.createElement('div');
                card.className = 'template-card';
                card.id = 'claimTpl' + i;
                card.onclick = () => selectClaimTemplate(i);
                card.innerHTML = `
                    <div class="template-icon">${tpl.icon || '📦'}</div>
                    <div class="template-name">${tpl.productName}</div>
                    <div class="template-desc">${tpl.description || ''}</div>
                    <div class="template-meta">
                        ${tpl.media && tpl.media.length > 0 ? `<span class="template-meta-pill">📸 ${tpl.media.length}</span>` : ''}
                        ${tpl.files && tpl.files.length > 0 ? `<span class="template-meta-pill">📄 ${tpl.files.length}</span>` : ''}
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // "Custom" option
        const customCard = document.createElement('div');
        customCard.className = 'template-add-card';
        customCard.onclick = () => {
            // Skip claim, go to manual form
            navigate('business');
        };
        customCard.innerHTML = `
            <div class="template-add-icon">✏️</div>
            <div class="template-add-label">Custom Entry</div>
        `;
        grid.appendChild(customCard);

        // Reset customize area
        document.getElementById('claimCustomize').style.display = 'none';
        document.getElementById('claimSummary').style.display = 'none';
        document.getElementById('claimBtn').disabled = true;
        document.getElementById('claimBtn').style.opacity = '0.5';
        document.getElementById('claimBtn').textContent = 'Select a template first';
        mediaFiles.claim = [];
    }

    function selectClaimTemplate(index) {
        selectedTemplateIndex = index;
        const tpl = businessProfile.templates[index];

        // Highlight selected
        document.querySelectorAll('#claimTemplateGrid .template-card').forEach((c, i) => {
            c.classList.toggle('selected', i === index);
        });

        // Show customize area with template data pre-filled
        document.getElementById('claimCustomize').style.display = 'block';
        document.getElementById('claimProdName').value = tpl.productName;
        document.getElementById('claimDesc').value = tpl.description || '';

        // Show summary
        document.getElementById('claimSummary').style.display = 'block';
        document.getElementById('claimSumBiz').textContent = businessProfile.name;
        document.getElementById('claimSumProd').textContent = tpl.productName;
        document.getElementById('claimSumContact').textContent =
            [businessProfile.email, businessProfile.phone].filter(Boolean).join(' · ') || '—';

        // Enable claim button
        const btn = document.getElementById('claimBtn');
        btn.disabled = false;
        btn.style.opacity = '1';
        btn.textContent = '🔗 Claim This QR Code';
    }

    function claimQRCode() {
        if (selectedTemplateIndex < 0 || !businessProfile) return;

        const tpl = businessProfile.templates[selectedTemplateIndex];

        // Build businessData from profile + template + customizations
        businessData = {
            businessName: businessProfile.name,
            productName: document.getElementById('claimProdName').value || tpl.productName,
            description: document.getElementById('claimDesc').value || tpl.description,
            email: businessProfile.email,
            phone: businessProfile.phone,
            links: businessProfile.links || [],
            media: [...(businessProfile.media || []), ...(tpl.media || []), ...mediaFiles.claim],
            files: tpl.files || []
        };

        qrCodeOwner = currentUser;
        console.log('🔗 QR code claimed:', businessData.businessName, '→', businessData.productName);
        console.log('⚡ Claimed in seconds using profile + template!');

        document.getElementById('successMsg').textContent =
            'QR code claimed! "' + businessData.productName + '" is now live.';
        navigate('success');
    }

    // ==========================================
    // GIVER FORM
    // ==========================================
    function saveGiver() {
        const name = document.getElementById('giverName').value;
        const msg = document.getElementById('giverMsg').value;
        if (!name || !msg) { alert('Please fill in your name and message'); return; }

        giverData = {
            giverName: name,
            recipientName: document.getElementById('recipName').value,
            message: msg,
            occasion: document.getElementById('occasion').value,
            media: mediaFiles.giver
        };

        console.log('💾 Giver saved:', giverData);
        giverUserId = currentUser;
        qrAnalytics.giverMessages++;
        document.getElementById('successMsg').textContent = 'Your personal message has been added! The recipient will see it when they scan the code.';
        navigate('success');
    }

    // ==========================================
    // RESPONSE FORM
    // ==========================================
    function saveResponse() {
        const msg = document.getElementById('responseMsg').value;
        if (!msg) { alert('Please write a response'); return; }

        responseData = { message: msg, media: mediaFiles.resp };

        console.log('💾 Response saved:', responseData);
        receiverUserId = currentUser;
        qrAnalytics.receiverResponses++;
        document.getElementById('successMsg').textContent = 'Your response has been sent! The giver will see your message.';
        navigate('success');
    }

    // ==========================================
    // SAVE TO COLLECTION
    // ==========================================
    function saveToCollection() {
        if (!isAuthenticated) {
            currentRole = 'receiver';
            navigate('auth');
            return;
        }

        // Add this thread to user's tapestry
        const newThread = {
            id: Date.now(),
            category: 'thing',
            title: businessData.productName || businessData.businessName || 'New Thread',
            from: giverData.giverName || businessData.businessName || 'Unknown',
            message: giverData.message || businessData.description || 'A meaningful connection.',
            date: new Date().toISOString().split('T')[0],
            tags: [giverData.occasion || 'Gift'].filter(Boolean),
            icon: '🎁'
        };

        userThreads.unshift(newThread);
        qrAnalytics.savedToTapestry++;
        console.log('💝 Saved to tapestry:', newThread);

        document.getElementById('successMsg').textContent = 'Saved to your tapestry! View your growing collection of meaningful threads.';
        navigate('success');
    }

    // ==========================================
    // THREAD VIEW (Content Display)
    // ==========================================
    function displayContent() {
        const isBizOwner = isBusinessOwnerViewing();
        console.log('📄 Displaying content. Business owner viewing:', isBizOwner);

        // Increment scan count each time thread is viewed
        qrAnalytics.totalScans++;

        // === BUSINESS INFO (always visible) ===
        document.getElementById('displayBizName').textContent = businessData.businessName || 'Happy Flowers';
        document.getElementById('displayProdName').textContent = businessData.productName || 'Spring Bouquet Collection';
        document.getElementById('displayDesc').textContent = businessData.description || 'Hand-selected seasonal blooms arranged fresh this morning with care and love.';
        document.getElementById('displayEmail').textContent = businessData.email || 'hello@happyflowers.com';
        document.getElementById('displayPhone').textContent = businessData.phone || '(555) 123-4567';

        // Links
        const linksEl = document.getElementById('linksDisplay');
        linksEl.innerHTML = '';
        if (businessData.links && businessData.links.length > 0) {
            linksEl.innerHTML = '<div class="section-title">Connect With Us</div>';
            businessData.links.forEach(link => {
                linksEl.innerHTML += `<a href="${link}" class="link-item" target="_blank"><div class="contact-icon">🌐</div><div style="flex:1; word-break:break-all;">${link}</div><div style="color:var(--text-muted);">→</div></a>`;
            });
        }

        // Media
        const mediaEl = document.getElementById('mediaDisplay');
        mediaEl.innerHTML = '';
        if (businessData.media && businessData.media.length > 0) {
            mediaEl.innerHTML = '<div class="section-title">Photos & Videos</div><div class="media-gallery">';
            businessData.media.forEach(item => {
                const tag = item.type.startsWith('image') ? 'img' : 'video';
                mediaEl.innerHTML += `<div class="media-item"><${tag} src="${item.data}"></${tag}><div class="media-badge">${item.type.startsWith('image') ? 'Photo' : 'Video'}</div></div>`;
            });
            mediaEl.innerHTML += '</div>';
        }

        // Files
        const filesEl = document.getElementById('filesDisplay');
        filesEl.innerHTML = '';
        if (businessData.files && businessData.files.length > 0) {
            filesEl.innerHTML = '<div class="section-title">Documents</div>';
            businessData.files.forEach(file => {
                filesEl.innerHTML += `<div class="file-item"><div class="file-icon">📄</div><div class="file-info"><div class="file-name">${file.name}</div><div class="file-size">${(file.size/1024).toFixed(1)} KB</div></div></div>`;
            });
        }

        // === PRIVACY LAYER: Business owner vs. everyone else ===
        if (isBizOwner) {
            // BUSINESS OWNER: show banner, analytics, privacy shield — hide personal content
            document.getElementById('bizOwnerBanner').style.display = 'block';
            document.getElementById('analyticsBar').style.display = 'block';
            document.getElementById('privacyShield').style.display = 'block';
            document.getElementById('personalContent').style.display = 'none';

            // Populate analytics
            document.getElementById('analyticScans').textContent = qrAnalytics.totalScans;
            document.getElementById('analyticGivers').textContent = qrAnalytics.giverMessages;
            document.getElementById('analyticResponses').textContent = qrAnalytics.receiverResponses;
            document.getElementById('analyticSaved').textContent = qrAnalytics.savedToTapestry;

            // Show blurred hints that personal content exists (without revealing it)
            document.getElementById('blurredGiver').style.display = qrAnalytics.giverMessages > 0 ? 'block' : 'none';
            document.getElementById('blurredResponse').style.display = qrAnalytics.receiverResponses > 0 ? 'block' : 'none';

        } else {
            // GIVER / RECEIVER / GUEST: show personal content, hide business controls
            document.getElementById('bizOwnerBanner').style.display = 'none';
            document.getElementById('analyticsBar').style.display = 'none';
            document.getElementById('privacyShield').style.display = 'none';
            document.getElementById('personalContent').style.display = 'block';

            // Giver message
            const giverEl = document.getElementById('giverMessageDisplay');
            giverEl.innerHTML = '';
            if (giverData.giverName) {
                let html = `<div class="message-block"><div class="message-from">Message from ${giverData.giverName}</div><p class="message-text">"${giverData.message}"</p>`;
                if (giverData.occasion) html += `<div style="margin-top:0.75rem; font-style:italic; color:var(--text-muted); font-size:0.9rem;">Occasion: ${giverData.occasion}</div>`;
                if (giverData.media && giverData.media.length > 0) {
                    html += '<div style="margin-top:1rem;"><div class="section-title">From the Gift Giver</div><div class="media-gallery">';
                    giverData.media.forEach(item => {
                        const tag = item.type.startsWith('image') ? 'img' : 'video';
                        html += `<div class="media-item"><${tag} src="${item.data}"></${tag}><div class="media-badge">${item.type.startsWith('image') ? 'Photo' : 'Video'}</div></div>`;
                    });
                    html += '</div></div>';
                }
                html += '</div>';
                giverEl.innerHTML = html;
            }

            // Respond section — only show to non-givers when there's a message to respond to
            const showRespondPrompt = giverData.giverName && !responseData.message && !isGiverViewing();
            document.getElementById('respondSection').style.display = showRespondPrompt ? 'block' : 'none';

            // Receiver response
            const recvRespEl = document.getElementById('receiverResponseDisplay');
            recvRespEl.innerHTML = '';
            if (responseData.message) {
                let html = `<div class="message-block" style="background:#f0faf4; border-left-color:var(--sage);"><div class="message-from">Response from the Receiver</div><p class="message-text">"${responseData.message}"</p>`;
                if (responseData.media && responseData.media.length > 0) {
                    html += '<div style="margin-top:1rem;"><div class="section-title">Enjoying the Gift</div><div class="media-gallery">';
                    responseData.media.forEach(item => {
                        const tag = item.type.startsWith('image') ? 'img' : 'video';
                        html += `<div class="media-item"><${tag} src="${item.data}"></${tag}><div class="media-badge">${item.type.startsWith('image') ? 'Photo' : 'Video'}</div></div>`;
                    });
                    html += '</div></div>';
                }
                html += '</div>';
                recvRespEl.innerHTML = html;
            }

            // Save to collection — show to anyone with content to save (except business owner)
            document.getElementById('saveToCollection').style.display =
                (giverData.giverName || responseData.message) ? 'block' : 'none';

            // ===========================
            // CONTEXT-AWARE ACTION BUTTONS
            // ===========================
            const actEl = document.getElementById('actionButtons');
            let btns = '';
            const hasGiver = !!giverData.giverName;
            const hasResponse = !!responseData.message;
            const amGiver = isGiverViewing();
            const amReceiver = isReceiverViewing();

            if (!hasGiver && !hasResponse) {
                // BLANK QR — anyone can claim a role
                btns = '<div class="action-title">What would you like to do?</div>';
                btns += '<div class="action-subtitle">This item doesn\'t have a personal message yet</div>';
                btns += '<div class="btn-group">';
                btns += '<button class="btn btn-primary" onclick="handleAction(\'giver\')">🎁 I\'m Giving This as a Gift</button>';
                btns += '<button class="btn btn-secondary" onclick="handleAction(\'respond\')">💝 I Received This</button>';
                btns += '</div>';

            } else if (hasGiver && !hasResponse) {
                if (amGiver) {
                    // GIVER viewing their own message — they can edit
                    btns = '<div class="action-title">Your Message Is Live ✨</div>';
                    btns += '<div class="action-subtitle">When the recipient scans this code, they\'ll see your message</div>';
                    btns += '<div class="btn-group">';
                    btns += '<button class="btn btn-secondary" onclick="handleAction(\'giver\')">✏️ Edit My Message</button>';
                    btns += '</div>';
                } else {
                    // RECEIVER (or anyone else) seeing the giver's message — they can respond
                    btns = '<div class="action-title">This Gift Has a Message for You</div>';
                    btns += '<div class="action-subtitle">Read the message above and respond to let them know you received it</div>';
                    btns += '<div class="btn-group">';
                    btns += '<button class="btn btn-primary" onclick="handleAction(\'respond\')">💌 Respond to ' + giverData.giverName + '</button>';
                    btns += '</div>';
                }

            } else if (hasGiver && hasResponse) {
                if (amGiver) {
                    // GIVER sees the response — the payoff moment!
                    btns = '<div class="action-title">They Responded! 💛</div>';
                    btns += '<div class="action-subtitle">Your gift made an impact — read their response above</div>';
                    btns += '<div class="btn-group">';
                    btns += '<button class="btn btn-primary" onclick="navigate(\'tapestry\')">Save to My Tapestry →</button>';
                    btns += '</div>';
                } else if (amReceiver) {
                    // RECEIVER revisiting — they can edit their response
                    btns = '<div class="action-title">Your Response Is Live ✨</div>';
                    btns += '<div class="action-subtitle">' + giverData.giverName + ' can now see your message</div>';
                    btns += '<div class="btn-group">';
                    btns += '<button class="btn btn-secondary" onclick="handleAction(\'editResponse\')">✏️ Edit My Response</button>';
                    btns += '<button class="btn btn-primary" onclick="navigate(\'tapestry\')">View My Tapestry →</button>';
                    btns += '</div>';
                } else {
                    // SOMEONE ELSE viewing a complete thread
                    btns = '<div class="action-title">A Beautiful Connection</div>';
                    btns += '<div class="action-subtitle">This thread tells the story of a meaningful gift</div>';
                    btns += '<div class="btn-group">';
                    btns += '<button class="btn btn-primary" onclick="navigate(\'tapestry\')">View My Tapestry →</button>';
                    btns += '</div>';
                }
            }

            actEl.innerHTML = btns;
        }
    }

    // ==========================================
    // RECEIVER VIEW
    // ==========================================
    function populateReceiver() {
        document.getElementById('recvBizName').textContent = businessData.businessName || 'Happy Flowers';
        document.getElementById('recvProdName').textContent =
            (businessData.productName || 'Spring Bouquet') + ' — ' +
            (businessData.description || 'Fresh seasonal flowers').substring(0, 60);

        const msgEl = document.getElementById('receiverMessageView');
        if (giverData.giverName) {
            msgEl.innerHTML = `<div class="message-block"><div class="message-from">Message from ${giverData.giverName}</div><p class="message-text">"${giverData.message}"</p>${giverData.occasion ? `<div style="margin-top:0.75rem; font-style:italic; color:var(--text-muted); font-size:0.9rem;">Occasion: ${giverData.occasion}</div>` : ''}</div>`;
        } else {
            msgEl.innerHTML = '<div class="alert alert-info"><strong>📝 Note:</strong> This is a gift without a personal message yet.</div>';
        }
    }

    // ==========================================
    // MEDIA HANDLING
    // ==========================================
    function handleMedia(input, type) {
        const container = document.getElementById(type + 'Previews');
        Array.from(input.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = function(e) {
                mediaFiles[type].push({ name: file.name, data: e.target.result, type: file.type });
                const div = document.createElement('div');
                div.className = 'preview-item';
                const tag = file.type.startsWith('image') ? 'img' : 'video';
                div.innerHTML = `<${tag} src="${e.target.result}"></${tag}><button class="preview-remove" onclick="this.parentElement.remove()">×</button><div class="preview-badge">${file.type.startsWith('image') ? 'Photo' : 'Video'}</div>`;
                container.appendChild(div);
            };
            reader.readAsDataURL(file);
        });
    }

    function handleFiles(input) {
        const container = document.getElementById('filesList');
        Array.from(input.files).forEach(file => {
            docFiles.push({ name: file.name, size: file.size, type: file.type });
            const div = document.createElement('div');
            div.className = 'file-item';
            div.innerHTML = `<div class="file-icon">📄</div><div class="file-info"><div class="file-name">${file.name}</div><div class="file-size">${(file.size/1024).toFixed(1)} KB</div></div><button class="btn-icon" onclick="this.parentElement.remove()">×</button>`;
            container.appendChild(div);
        });
    }

    // ==========================================
    // TAPESTRY
    // ==========================================
    function initTapestry() {
        updateStats();

        if (userThreads.length > 0) {
            document.getElementById('tapestryEmpty').style.display = 'none';
            document.getElementById('tapestryFilters').style.display = 'flex';
            document.getElementById('tapestryGrid').style.display = 'grid';
            document.getElementById('timelineSection').style.display = 'block';
            renderTapestry();
            renderTimeline();
        } else {
            document.getElementById('tapestryEmpty').style.display = 'block';
            document.getElementById('tapestryFilters').style.display = 'none';
            document.getElementById('tapestryGrid').style.display = 'none';
            document.getElementById('timelineSection').style.display = 'none';
        }
    }

    function updateStats() {
        const total = userThreads.length;
        const now = new Date();
        const thisMonth = userThreads.filter(t => {
            const d = new Date(t.date);
            return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
        }).length;
        const cats = new Set(userThreads.map(t => t.category)).size;

        document.getElementById('statTotal').textContent = total;
        document.getElementById('statMonth').textContent = thisMonth;
        document.getElementById('statCategories').textContent = cats;
    }

    function renderTapestry() {
        const grid = document.getElementById('tapestryGrid');
        grid.innerHTML = '';

        let filtered = userThreads;

        // Category filter
        if (currentFilter !== 'all') {
            filtered = filtered.filter(t => t.category === currentFilter);
        }

        // Search filter
        const search = (document.getElementById('tapestrySearch')?.value || '').toLowerCase();
        if (search) {
            filtered = filtered.filter(t =>
                t.title.toLowerCase().includes(search) ||
                t.from.toLowerCase().includes(search) ||
                t.message.toLowerCase().includes(search) ||
                t.tags.some(tag => tag.toLowerCase().includes(search))
            );
        }

        if (filtered.length === 0) {
            grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:3rem; color:var(--text-muted);">No threads found</div>';
            return;
        }

        filtered.forEach(thread => {
            const catClass = thread.category === 'thing' ? 'cat-thing' : thread.category === 'person' ? 'cat-person' : 'cat-place';
            const catLabel = thread.category === 'thing' ? '🎁 Thing' : thread.category === 'person' ? '👤 Person' : '📍 Place';
            const date = new Date(thread.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            const isExternal = thread.source === 'external_scan';
            const fromLabel = isExternal ? thread.from : 'From ' + thread.from;
            const photoThumb = thread.photos && thread.photos.length > 0
                ? `<img src="${thread.photos[0]}" style="width:100%;height:100%;object-fit:cover;border-radius:12px;">`
                : (thread.icon || '🧵');

            const card = document.createElement('div');
            card.className = 'thread-card';
            card.onclick = () => openThread(thread.id);
            card.innerHTML = `
                <div class="thread-card-image">${photoThumb}</div>
                <div class="thread-card-body">
                    <span class="thread-card-category ${catClass}">${catLabel}${isExternal ? ' · 🔗 Scan' : ''}</span>
                    <div class="thread-card-title">${thread.title}</div>
                    <div class="thread-card-from">${fromLabel}</div>
                    <div class="thread-card-msg">${thread.message}</div>
                    <div class="thread-tags">${thread.tags.map(t => `<span class="tag">${t}</span>`).join('')}</div>
                    <div class="thread-card-footer">
                        <span>📅 ${date}</span>
                        ${thread.isHidden ? '<span>👁️ Hidden</span>' : `<span>🧵 Thread #${thread.id}</span>`}
                    </div>
                </div>
            `;
            grid.appendChild(card);
        });
    }

    function filterTapestry(filter, el) {
        currentFilter = filter;
        document.querySelectorAll('#tapestryFilters .filter-tab').forEach(t => t.classList.remove('active'));
        if (el) el.classList.add('active');
        renderTapestry();
    }

    function renderTimeline() {
        const scroll = document.getElementById('timelineScroll');
        scroll.innerHTML = '';

        const sorted = [...userThreads].sort((a, b) => new Date(a.date) - new Date(b.date));

        sorted.forEach(thread => {
            const date = new Date(thread.date);
            const formatted = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            const day = date.toLocaleDateString('en-US', { weekday: 'short' });
            const icon = thread.category === 'thing' ? '🎁' : thread.category === 'person' ? '👤' : '📍';

            const card = document.createElement('div');
            card.className = 'timeline-card';
            card.onclick = () => openThread(thread.id);
            card.innerHTML = `
                <div class="timeline-date">${formatted}</div>
                <div class="timeline-day">${day}</div>
                <div class="timeline-icon">${icon}</div>
                <div class="timeline-title">${thread.title}</div>
                <div class="timeline-from">From ${thread.from}</div>
                <div class="timeline-msg">${thread.message}</div>
            `;
            scroll.appendChild(card);
        });
    }

    function openThread(id) {
        const thread = userThreads.find(t => t.id === id);
        if (!thread) return;

        console.log('Opening thread:', thread.title);

        const catIcons = { thing: '🎁', person: '👤', place: '📍' };
        const catLabels = { thing: 'Thing', person: 'Person', place: 'Place' };
        const icon = thread.icon || catIcons[thread.category] || '🧵';
        const catLabel = catLabels[thread.category] || 'Thread';
        const date = new Date(thread.date).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
        const isExternal = thread.source === 'external_scan';

        let html = `
            <div class="thread-detail-hero">
                <div class="thread-detail-icon">${icon}</div>
                <div class="thread-detail-title">${thread.title}</div>
                <div class="thread-detail-meta">${catLabel} · ${date}</div>
            </div>
        `;

        // External URL card
        if (isExternal && thread.externalUrl) {
            html += `
                <div class="thread-detail-card">
                    <h3>🔗 Original Link</h3>
                    <a href="${thread.externalUrl}" target="_blank" rel="noopener noreferrer" class="thread-detail-url">
                        <span style="font-size: 1.5rem;">🌐</span>
                        <span>${thread.externalUrl}</span>
                    </a>
                </div>
            `;
        }

        // From / connected to
        if (thread.from && thread.from !== 'Scanned QR') {
            html += `
                <div class="thread-detail-card">
                    <h3>${isExternal ? '🔗 Connected To' : '💌 From'}</h3>
                    <p style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary);">${thread.from}</p>
                </div>
            `;
        }

        // Message / Notes
        if (thread.message) {
            html += `
                <div class="thread-detail-card">
                    <h3>${isExternal ? '📝 Notes' : '💬 Message'}</h3>
                    <div class="thread-detail-message">${thread.message}</div>
                </div>
            `;
        }

        // Photos
        if (thread.photos && thread.photos.length > 0) {
            html += `
                <div class="thread-detail-card">
                    <h3>📸 Photos</h3>
                    <div class="thread-detail-photos">
                        ${thread.photos.map(p => `<img src="${p}" alt="Thread photo">`).join('')}
                    </div>
                </div>
            `;
        }

        // Tags
        if (thread.tags && thread.tags.length > 0) {
            html += `
                <div class="thread-detail-card">
                    <h3>🏷️ Tags</h3>
                    <div class="thread-detail-tags">
                        ${thread.tags.map(t => `<span class="tag">${t}</span>`).join('')}
                    </div>
                </div>
            `;
        }

        // Action buttons
        html += `
            <div style="display: flex; flex-direction: column; gap: 12px; margin: 2rem 0 3rem;">
                ${isExternal && thread.externalUrl ? `
                    <a href="${thread.externalUrl}" target="_blank" rel="noopener noreferrer" class="btn btn-primary" style="width: 100%; text-decoration: none; display: block; box-sizing: border-box; text-align: center;">
                        🌐 Open Original Link
                    </a>
                ` : ''}
                <button class="btn btn-secondary" onclick="hideThread(${thread.id})" style="width: 100%;">
                    ${thread.isHidden ? '👁️ Unhide from Tapestry' : '🙈 Hide from Tapestry'}
                </button>
                <button class="btn btn-secondary" onclick="navigate('tapestry')" style="width: 100%; border: none; color: var(--text-muted);">
                    ← Back to Tapestry
                </button>
            </div>
        `;

        document.getElementById('threadDetailContent').innerHTML = html;
        navigate('threadDetail');
    }

    function hideThread(id) {
        const thread = userThreads.find(t => t.id === id);
        if (!thread) return;
        thread.isHidden = !thread.isHidden;
        console.log(thread.isHidden ? '🙈 Thread hidden' : '👁️ Thread unhidden', thread.title);
        openThread(id); // Re-render to update button text
    }

    // ==========================================
    // ROUTING (hash-based + path-based for QR scans)
    // ==========================================
    function handleRoute() {
        const hash = window.location.hash || '#/';
        const path = window.location.pathname;

        // Check path-based QR URL first (from scanning: duyen.io/q/CODE)
        if (path.startsWith('/q/')) {
            const code = path.replace('/q/', '');
            console.log('📱 QR scan for code:', code);
            window.scannedQRCode = code;
            navigate('qr');
            return;
        }

        if (hash.startsWith('#/q/')) {
            // QR code scan: duyen.io/#/q/CODE
            const code = hash.replace('#/q/', '');
            console.log('📱 QR scan for code:', code);
            window.scannedQRCode = code;
            navigate('qr');
        } else if (hash === '#/tapestry') {
            navigate('tapestry');
        } else if (hash === '#/login') {
            navigate('auth');
        } else {
            // Default: welcome
            navigate('home');
        }
    }

    // Listen for hash changes
    window.addEventListener('hashchange', handleRoute);

    // Initial route
    window.addEventListener('DOMContentLoaded', function() {
        handleRoute();
    });
</script>
</body>
</html>
